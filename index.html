<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gato.TV Panel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&family=Permanent+Marker&family=Courier+Prime&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    :root { 
        --bg: #020617;        
        --panel: #0f172a;     
        --accent: #38bdf8; 
        --accent-glow: rgba(56, 189, 248, 0.6); 
        --twitch: #9146ff; 
        --yellow: #facc15; 
        --text: #f8fafc;      
        --text-muted: #94a3b8; 
        --border: #1e293b;    
        --border-hover: #334155;
        --danger: #ef4444; 
        --success: #22c55e;
    }
    * { box-sizing: border-box; }
    
    body { 
        margin: 0; 
        font-family: 'Outfit', sans-serif; 
        background: linear-gradient(to bottom, #0f172a, var(--bg)); 
        color: var(--text); 
        min-height: 100vh; 
        padding-bottom: 50px; 
        overflow-x: hidden; 
    }
    
    header { 
        background: #0f172a; 
        height: 60px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 30px; 
        border-bottom: 1px solid var(--border); 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
    }
    
    .header-left { display: flex; align-items: center; gap: 20px; flex: 1; }
    
    .logo { 
        font-size: 22px; 
        font-weight: 900; 
        color: var(--accent); 
        letter-spacing: -0.5px; 
        text-transform: uppercase; 
        text-shadow: 0 0 15px var(--accent-glow); 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        white-space: nowrap; 
        transition: 0.2s; 
    }
    .logo:hover { transform: scale(1.02); }
    
    .beta-tag { font-size: 9px; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-weight: 700; transform: translateY(-2px); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
    
    .btn-login-header { background: var(--twitch); color: white; border: none; padding: 7px 20px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 0 15px rgba(145, 70, 255, 0.15); }
    .btn-login-header:hover { background: #772ce8; transform: translateY(-1px); box-shadow: 0 0 20px rgba(145, 70, 255, 0.3); }
    
    .coin-display { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        background: rgba(15, 23, 42, 0.8); 
        border: 1px solid var(--yellow); 
        color: var(--yellow); 
        padding: 5px 12px; 
        border-radius: 8px; 
        font-weight: 800; 
        font-size: 13px; 
        margin-right: 15px; 
        white-space: nowrap; 
        box-shadow: 0 0 9px rgba(250, 204, 21, 0.25); 
        cursor: pointer; 
        transition: 0.2s;
    }
    .coin-display:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(250, 204, 21, 0.6); background: rgba(250, 204, 21, 0.1); }
    
    .search-container { position: relative; width: 280px; margin-left: 15px; display: none; }
    .search-input { width: 100%; background: #1e293b; border: 1px solid var(--border); color: white; padding: 8px 15px 8px 38px; border-radius: 50px; font-family: 'Outfit', sans-serif; font-size: 13px; transition: 0.2s; outline: none; }
    .search-input:focus { border-color: var(--accent); background: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.15); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px; pointer-events: none; }
    
    nav { display: flex; gap: 6px; background: transparent; padding: 0; }
    nav button { background: transparent; border: 1px solid transparent; color: var(--text-muted); font-size: 13px; font-weight: 600; padding: 7px 14px; cursor: pointer; border-radius: 8px; transition: 0.2s; }
    nav button:hover { color: #fff; background: rgba(255,255,255,0.03); border-color: var(--border); }
    nav button.active { background: #1e293b; color: white; font-weight: 700; border: 1px solid var(--border-hover); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    nav button.btn-purple.active { background: var(--twitch); color: white; border-color: var(--twitch); box-shadow: 0 0 20px rgba(145, 70, 255, 0.25); }
    nav button.btn-yellow.active { background: var(--yellow); color: black; border-color: var(--yellow); box-shadow: 0 0 20px rgba(250, 204, 21, 0.25); }
    
    .container { width: 100%; max-width: 96%; margin: 30px auto; padding: 0 15px; }

    .panel { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .panel.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    /* UNIFIED LOGIN BLOCKER DESIGN */
    .login-blocker { 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        height: calc(100vh - 200px); padding: 40px; 
        background: radial-gradient(circle at top, rgba(145, 70, 255, 0.08), transparent 70%), #020617;
        border: 1px solid var(--border); border-radius: 24px; 
        margin-top: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
        text-align: center; position: relative; overflow: hidden;
    }
    .login-blocker::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 24px 24px; opacity: 0.3; pointer-events: none; }
    
    .lb-icon-box { width: 70px; height: 70px; background: linear-gradient(135deg, rgba(145, 70, 255, 0.2), rgba(145, 70, 255, 0.05)); border: 1px solid rgba(145, 70, 255, 0.3); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--twitch); margin-bottom: 25px; box-shadow: 0 0 30px rgba(145, 70, 255, 0.15); animation: floatIcon 4s ease-in-out infinite; }
    @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    .lb-title { font-size: 28px; font-weight: 900; color: white; margin-bottom: 12px; letter-spacing: -0.5px; }
    .lb-desc { color: var(--text-muted); font-size: 14px; max-width: 400px; margin-bottom: 30px; line-height: 1.6; }
    
    .secure-badge { margin-top: 30px; background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 8px 16px; border-radius: 50px; font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(34, 197, 94, 0.2); text-transform: uppercase; letter-spacing: 0.5px; backdrop-filter: blur(5px); animation: breathe 3s ease-in-out infinite; }
    @keyframes breathe { 0%, 100% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); transform: scale(1.05); } }
    
    .login-options { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
    .btn-login-option { padding: 14px 28px; border-radius: 12px; border: none; font-weight: 800; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-twitch { background: #9146ff; box-shadow: 0 4px 15px rgba(145, 70, 255, 0.25); } .btn-twitch:hover { background: #772ce8; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(145, 70, 255, 0.4); }
    .btn-kick { background: #53fc18; color: black; box-shadow: 0 4px 15px rgba(83, 252, 24, 0.25); } .btn-kick:hover { background: #42c912; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(83, 252, 24, 0.4); }
    
    .profile-header { position: relative; margin-bottom: 20px; background: var(--panel); border: 1px solid var(--border); border-radius: 24px; overflow: hidden; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .profile-banner { height: 170px; background: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2072&auto=format&fit=crop') center/cover; position: relative; }
    .profile-banner::after { content:''; position: absolute; bottom:0; left:0; width:100%; height:100%; background: linear-gradient(to top, var(--panel) 0%, rgba(15, 23, 42, 0.5) 50%, transparent 100%); }

    .profile-meta-container { position: absolute; bottom: 20px; left: 40px; display: flex; align-items: center; gap: 20px; z-index: 10; width: auto; }
    .profile-avatar-big { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--panel); background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    .profile-info-block { display: flex; flex-direction: column; justify-content: center; margin: 0; }
    .profile-name-big { font-size: 26px; font-weight: 900; color: white; text-shadow: 0 2px 20px rgba(0,0,0,0.8); line-height: 1.1; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
    .profile-role-tag { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; background: rgba(56, 189, 248, 0.15); padding: 3px 8px; border-radius: 6px; display: inline-block; margin-top: 4px; border: 1px solid rgba(56, 189, 248, 0.3); backdrop-filter: blur(4px); }
    .viewing-badge { font-size: 10px; background: var(--yellow); color: black; padding: 2px 8px; border-radius: 20px; vertical-align: middle; font-weight: 800; }
    
    .profile-nav-centered { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; background: rgba(15, 23, 42, 0.9); padding: 6px; border-radius: 50px; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); z-index: 20; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .profile-nav-centered button { background: transparent; border: none; color: #94a3b8; font-size: 12px; font-weight: 700; padding: 10px 22px; border-radius: 40px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .profile-nav-centered button:hover { color: white; background: rgba(255,255,255,0.05); }
    .profile-nav-centered button.active { background: var(--twitch); color: white; box-shadow: 0 4px 20px rgba(145, 70, 255, 0.4); transform: translateY(-1px); }

    .back-to-me-btn { position: absolute; top: 15px; right: 20px; background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 8px; cursor: pointer; font-weight: bold; backdrop-filter: blur(5px); transition: 0.2s; z-index: 10; display: none; font-size: 11px; }
    .back-to-me-btn:hover { background: var(--twitch); border-color: var(--twitch); }

    .profile-content-area { padding: 30px; }
    .profile-section-title { font-size: 18px; font-weight: 800; color: white; margin-bottom: 20px; border-left: 4px solid var(--twitch); padding-left: 15px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
    
    .chat-preview-container { max-width: 600px; margin: 0 auto 30px auto; background: #020617; border: 1px solid var(--border); border-radius: 12px; padding: 15px 25px; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 10; flex-wrap: wrap; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    
    /* FIXED PREVIEW IN PROFILE */
    #previewContainer {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        margin: 0;
        z-index: 950;
        background: rgba(2, 6, 23, 0.9);
        backdrop-filter: blur(12px);
        border-color: var(--accent);
        box-shadow: 0 0 40px rgba(0,0,0,0.6);
        width: 90%;
        display: none; /* Ukryte domyślnie, JS zarządza widocznością */
    }
    
    /* Fix dla motywu - !important nadpisuje style ID */
    #previewContainer.light { background: #f8fafc !important; border-color: #cbd5e1 !important; }
    #previewContainer.light .chat-msg { color: #0f172a !important; }

    .chat-preview-container.light { background: #f8fafc; border-color: #cbd5e1; }
    .chat-preview-container.light .chat-msg { color: #0f172a; }
    .chat-preview-container.light .chat-time { color: #64748b; }
    .chat-line { display: flex; align-items: center; font-size: 14px; flex-wrap: wrap; }
    .chat-time { margin-right: 12px; color: #64748b; font-size: 12px; font-weight: 500; }
    .chat-username { font-weight: 700; color: #22c55e; margin-right: 5px; white-space: nowrap; }
    .chat-msg { color: #e2e8f0; word-break: break-word; }
    .gato-badge-preview { width: 18px; height: 18px; border-radius: 3px; vertical-align: middle; margin-right: 4px; }
    
    .preview-theme-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: auto; transition: 0.2s; }
    .preview-theme-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-muted); }

    .btn-primary { background: var(--twitch); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(145,70,255,0.25); }
    .btn-primary:hover { background: #772ce8; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(145,70,255,0.35); }
    .btn-primary.small { font-size: 12px; padding: 8px 16px; }
    
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: rgba(56,189,248,0.05); }
    
    .btn-secondary { background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-secondary:hover { background: #475569; }

    .btn-huge { background: var(--twitch); color: white; border: none; width: 100%; padding: 40px; border-radius: 20px; font-weight: 900; font-size: 24px; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 40px rgba(145, 70, 255, 0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; text-transform: uppercase; letter-spacing: 1px; border: 2px solid rgba(255,255,255,0.05); }
    .btn-huge:hover { transform: translateY(-5px); background: #772ce8; box-shadow: 0 20px 60px rgba(145, 70, 255, 0.4); border-color: rgba(255,255,255,0.2); }

    .preset-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; }
    .preset-card { width: 220px; background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 8px; cursor: pointer; text-align: center; transition: 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .preset-card:hover { border-color: var(--text-muted); transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
    .preset-card.owned { border-color: var(--success); background: rgba(34, 197, 94, 0.03); }
    .preset-card .card-preview { padding: 40px 10px; font-size: 22px; font-weight: 900; display:flex; align-items:center; justify-content:center; height: 120px; background: #020617; border-radius: 12px 12px 0 0; border: 1px solid rgba(255,255,255,0.03); }
    .preset-card .card-info { background: var(--panel); padding: 15px; border-radius: 0 0 12px 12px; display: flex; flex-direction: column; gap: 10px; flex: 1; justify-content: flex-end; }
    .preset-card .preset-name { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; display: block; }

    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; margin-bottom: 30px; } 
    .inventory-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 6px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: row; height: 75px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .inventory-card:hover { border-color: var(--text-muted); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .inventory-card.owned { border-color: var(--success); background: rgba(34, 197, 94, 0.03); }
    .inventory-card .card-preview { height: 100%; width: 55px; padding: 5px; font-size: 16px; font-weight: 900; display:flex; align-items:center; justify-content:center; border-right: 1px solid var(--border); flex-shrink: 0; background: rgba(0,0,0,0.2); border-radius: 8px 0 0 8px; }
    .inventory-card .card-info { background: transparent; padding: 0 0 0 12px; display: flex; flex-direction: column; justify-content: center; flex: 1; align-items: flex-start; height: 100%; }
    .inventory-card .preset-name { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 700; display: block; margin-bottom: 6px; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90px; }

    /* NEW INVENTORY HEADER & CONTROLS */
    .inventory-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
    .inv-title-box { display: flex; align-items: center; gap: 15px; }
    .inv-icon { width: 45px; height: 45px; background: linear-gradient(135deg, var(--twitch), #d946ef); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; box-shadow: 0 4px 15px rgba(145, 70, 255, 0.3); }
    .inv-title-box h2 { margin: 0; font-size: 20px; font-weight: 800; color: white; letter-spacing: -0.5px; }
    .inv-title-box p { margin: 2px 0 0 0; font-size: 12px; color: var(--text-muted); }
    
    .inv-controls { display: flex; gap: 10px; }
    .search-wrapper { position: relative; }
    .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; }
    .search-wrapper input { background: #020617; border: 1px solid var(--border); padding: 8px 12px 8px 32px; border-radius: 8px; color: white; font-size: 12px; width: 180px; outline: none; transition: 0.2s; }
    .search-wrapper input:focus { border-color: var(--accent); width: 220px; }
    
    .inv-filters { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn { background: var(--panel); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .filter-btn:hover { background: #1e293b; color: white; }
    .filter-btn.active { background: var(--twitch); color: white; border-color: var(--twitch); box-shadow: 0 2px 10px rgba(145, 70, 255, 0.2); }
    
    .fav-btn { position: absolute; top: 5px; right: 5px; color: rgba(255,255,255,0.3); cursor: pointer; z-index: 5; transition: 0.2s; font-size: 14px; }
    .fav-btn:hover { color: #f43f5e; transform: scale(1.2); }
    .fav-btn.active { color: #f43f5e; text-shadow: 0 0 10px rgba(244, 63, 94, 0.5); }

    .empty-state-styled { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--text-muted); gap: 15px; border: 2px dashed var(--border); border-radius: 12px; background: rgba(15, 23, 42, 0.3); width: 100%; }
    .empty-state-styled i { font-size: 32px; color: var(--border-hover); }
    .empty-state-styled span { font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }

    .btn-action { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
    .inventory-card .btn-action { width: auto; padding: 5px 10px; font-size: 10px; border-radius: 6px; }

    .btn-buy { background: var(--yellow); color: #000; box-shadow: 0 4px 10px rgba(250, 204, 21, 0.2); }
    .btn-buy:hover { background: #fbbf24; }
    .btn-equip { background: var(--success); color: #000; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2); }
    .btn-equip:hover { background: #4ade80; }
    .btn-unequip { background: var(--danger); color: #fff; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
    .btn-unequip:hover { background: #f87171; }

    .category-badge { position: absolute; top:5px; left:5px; padding:3px 6px; border-radius:4px; font-size:9px; font-weight:bold; text-transform:uppercase; color:white; z-index: 2; pointer-events: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    
    .cat-paint { background: #38bdf8; } .cat-badge { background: #9146ff; } .cat-ink { background: #f43f5e; } .cat-font { background: #10b981; } .cat-bg { background: #f59e0b; }
    .shop-section-title { width: 100%; font-size: 14px; font-weight: 800; color: var(--accent); margin: 35px 0 15px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
    
    .emotes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 25px; }
    .emote-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; position: relative; transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-height: 130px; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .emote-card:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .emote-card img { height: 50px; width: auto; max-width: 100%; object-fit: contain; margin-bottom: 12px; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    .emote-card .name { font-weight: 700; font-size: 13px; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
    .emote-card .author { font-size: 10px; color: var(--text-muted); margin-top: 5px; }
    .action-overlay { position: absolute; top: 6px; right: 6px; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; opacity: 0; transition: 0.2s; font-size: 12px; color: white; z-index: 2; }
    .emote-card:hover .action-overlay { opacity: 1; }
    .del-btn { background: var(--danger); box-shadow: 0 2px 8px rgba(239,68,68,0.4); }
    .edit-btn { background: var(--yellow); color: black; right: 34px; box-shadow: 0 2px 8px rgba(250, 204, 21, 0.4); }
    
    .emote-sub-nav { display:flex; gap:10px; margin-bottom:20px; }
    .emote-sub-nav button { background: var(--panel); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
    .emote-sub-nav button:hover { background: #1e293b; color: white; }
    .emote-sub-nav button.active { background: var(--accent); color: #020617; border-color: var(--accent); font-weight: 800; box-shadow: 0 0 15px var(--accent-glow); }

    /* NOWE STYLE DLA UKŁADU EMOTES (Header) - SPÓJNE Z DESIGNEM */
    .emotes-header-layout { display: flex; justify-content: space-between; align-items: center; width: 100%; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 25px; }
    .emotes-header-left { display: flex; align-items: center; gap: 25px; }
    
    .emote-sub-nav-inline { display: flex; gap: 10px; background: var(--panel); padding: 4px; border-radius: 10px; border: 1px solid var(--border); }
    .emote-sub-nav-inline button { background: transparent; border: none; color: var(--text-muted); padding: 6px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.2s; }
    .emote-sub-nav-inline button:hover { color: white; background: rgba(255,255,255,0.05); }
    .emote-sub-nav-inline button.active { background: var(--accent); color: #020617; font-weight: 800; box-shadow: 0 0 15px var(--accent-glow); }

    .btn-add-header { background: var(--twitch); color: white; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 15px rgba(145, 70, 255, 0.25); text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-add-header:hover { background: #772ce8; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(145, 70, 255, 0.4); }
    
    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: #0f172a; border: 1px solid var(--border); width: 90%; max-width: 420px; border-radius: 24px; overflow: hidden; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-head { background: #1e293b; padding: 35px; text-align: center; border-bottom: 1px solid var(--border); position: relative; }
    .modal-close { position: absolute; top: 20px; right: 25px; background: none; border: none; color: #94a3b8; font-size: 26px; cursor: pointer; transition: 0.2s; }
    .modal-close:hover { color: white; }
    .modal-content { padding: 35px; text-align: center; }
    .modal-btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 15px; font-size: 14px; }
    
    .btn-daily { margin-left: auto; background: linear-gradient(45deg, #facc15, #f59e0b); color: #000; border: none; border-radius: 50px; padding: 8px 20px; font-size: 12px; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px rgba(250, 204, 21, 0.3); display: flex; align-items: center; gap: 8px; width: auto; justify-content: center; transition: 0.2s; }
    .btn-daily:hover { transform: translateY(-1px); box-shadow: 0 0 30px rgba(250, 204, 21, 0.5); }
    .btn-daily:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }
    
    .redeem-btn { position: fixed; bottom: 20px; right: 30px; background: linear-gradient(135deg, #ef4444, #f43f5e); color: white; padding: 14px 28px; border-radius: 50px; font-weight: 800; cursor: pointer; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.25); z-index: 999; display: none; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; border: 2px solid rgba(255,255,255,0.1); }
    .redeem-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(239, 68, 68, 0.5); }
    
    .wip-container { display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .wip-icon { font-size: 80px; color: #1e293b; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 0.3; } }
    
    .hero-card { background: linear-gradient(135deg, rgba(56, 189, 248, 0.08), rgba(0,0,0,0)); border: 1px solid var(--border); border-radius: 24px; padding: 80px 40px; text-align: center; margin-top: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .hero-card h1 { font-size: 42px; font-weight: 900; margin-bottom: 15px; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; color: transparent; letter-spacing: -1px; }
    .btn-download-big { background: var(--yellow); color: #000; font-size: 18px; font-weight: 900; padding: 18px 45px; border: none; border-radius: 14px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin-top: 30px; box-shadow: 0 10px 30px rgba(250, 204, 21, 0.3); transition: 0.2s; }
    .btn-download-big:hover { transform: translateY(-3px); box-shadow: 0 20px 50px rgba(250, 204, 21, 0.4); }
    
    /* NEW DOWNLOAD SECTION STYLES (2026 Modern) */
    .download-hero {
        position: relative;
        padding: 40px;
        border-radius: 30px;
        background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.15), transparent 40%),
                    radial-gradient(circle at bottom left, rgba(145, 70, 255, 0.15), transparent 40%),
                    #0f172a;
        border: 1px solid rgba(255,255,255,0.05);
        overflow: hidden;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        margin-top: 20px;
        min-height: calc(100vh - 180px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .download-hero::before {
        content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
        background: url('https://www.transparenttextures.com/patterns/cubes.png');
        opacity: 0.05; pointer-events: none;
    }
    .dl-title {
        font-size: 56px; font-weight: 900; letter-spacing: -2px; margin-bottom: 10px;
        background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
        -webkit-background-clip: text; color: transparent;
        position: relative; z-index: 2;
    }
    .dl-subtitle {
        font-size: 18px; color: #94a3b8; margin-bottom: 40px; font-weight: 500;
        position: relative; z-index: 2;
    }
    .dl-btn-main {
        background: linear-gradient(90deg, var(--yellow), #f59e0b);
        color: #000; font-size: 18px; font-weight: 900;
        padding: 20px 50px; border-radius: 16px; border: none;
        cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 30px rgba(250, 204, 21, 0.3);
        text-transform: uppercase; letter-spacing: 1px;
        position: relative; z-index: 2; display: inline-flex; align-items: center; gap: 12px;
    }
    .dl-btn-main:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 20px 50px rgba(250, 204, 21, 0.5);
    }
    .dl-features {
        display: flex; justify-content: center; gap: 30px;
        width: 100%; max-width: 1100px;
        margin-top: 50px; position: relative; z-index: 2; flex-wrap: wrap;
    }
    .dl-feat-card {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
        padding: 30px; border-radius: 20px; text-align: left;
        backdrop-filter: blur(10px); transition: 0.3s;
        flex: 1; min-width: 260px; max-width: 350px;
    }
    .dl-feat-card:hover {
        background: rgba(255,255,255,0.06); transform: translateY(-5px);
        border-color: var(--accent);
    }
    .dl-icon {
        font-size: 28px; color: var(--accent); margin-bottom: 15px;
        background: rgba(56, 189, 248, 0.1); width: 60px; height: 60px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 14px;
    }
    
    .info-block { margin-top: 80px; border-top: 1px solid var(--border); padding-top: 50px; text-align: left; }
    .info-grid-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
    .info-item { background: var(--panel); padding: 35px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .info-item h3 { color: white; margin-top: 0; font-size: 20px; }
    
    .manage-section { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 30px; margin-bottom: 30px; }
    .manage-header { font-size: 20px; font-weight: 800; color: white; margin-bottom: 20px; display:flex; align-items:center; gap:10px; }
    .mod-item { display: flex; justify-content: space-between; align-items: center; background: #020617; padding: 15px; border-radius: 10px; border: 1px solid var(--border); font-size: 14px; font-weight: 600; }
    .btn-remove-mod { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: 0.2s; }
    .btn-remove-mod:hover { background: rgba(239, 68, 68, 0.2); }
    
    .fixed-bottom-controls { position: fixed; bottom: 90px; left: 25px; display: none; gap: 10px; z-index: 999; align-items: center; }
    .role-badge, .connections-btn { height: 28px; display: flex; align-items: center; justify-content: center; padding: 0 12px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid var(--border); background: #0f172a; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: 0.2s; }
    .role-user { border-color: rgba(34, 197, 94, 0.3); color: var(--success); }
    .role-admin { border-color: rgba(239, 68, 68, 0.3); color: var(--danger); cursor: pointer; }
    .role-admin:hover { transform: scale(1.05); background: rgba(239, 68, 68, 0.1); }
    .connections-btn { color: var(--text-muted); cursor: pointer; text-decoration: none; }
    .connections-btn:hover { border-color: var(--accent); color: white; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2); }
    .btn-login { background: var(--twitch); color: white; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 0 20px rgba(145, 70, 255, 0.2); font-size: 14px; }
    .btn-login:hover { background: #772ce8; transform: translateY(-2px); box-shadow: 0 0 30px rgba(145, 70, 255, 0.4); }

    .user-profile-floater { position: fixed; bottom: 20px; left: 20px; z-index: 900; display: none; align-items: center; gap: 12px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border); padding: 8px 15px 8px 8px; border-radius: 50px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); transition: transform 0.2s; }
    .user-profile-floater:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 10px 40px rgba(56, 189, 248, 0.15); }
    .floater-avatar { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--twitch); }
    .floater-info { display: flex; flex-direction: column; line-height: 1.1; }
    .floater-name { font-weight: 700; color: white; font-size: 13px; }
    .btn-logout-mini { background: none; border: none; color: var(--text-muted); font-size: 10px; cursor: pointer; padding: 0; text-align: left; font-weight: 600; transition: color 0.2s; }
    .btn-logout-mini:hover { color: var(--danger); }

    .dashboard-full-container { display: flex; flex-direction: column; gap: 30px; }
    
    /* NEW SPLIT LAYOUT FOR SLOTS & RULES */
    .dashboard-top-split { display: grid; grid-template-columns: 1fr 300px; gap: 25px; align-items: start; }
    @media (max-width: 900px) { .dashboard-top-split { grid-template-columns: 1fr; } }

    .rules-box { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 16px; padding: 20px; font-size: 13px; color: var(--text-muted); }
    .rules-list { list-style: none; padding: 0; margin: 0; }
    .rules-list li { margin-bottom: 10px; display: flex; gap: 10px; align-items: start; }
    .rules-list i { color: var(--accent); margin-top: 3px; }
    .rules-title { color: white; font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
    
    .emote-slots-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; background: var(--panel); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; }
    @media (max-width: 800px) { .emote-slots-bar { grid-template-columns: repeat(3, 1fr); } }
    
    .slot-box { aspect-ratio: 1/1; background: #020617; border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.2s; overflow: hidden; }
    .slot-box:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.05); }
    
    .slot-box.pending { border-style: solid; border-color: var(--yellow); background: var(--panel); }
    .slot-box.approved { border-style: solid; border-color: var(--success); background: var(--panel); }
    
    .slot-content-img { width: 60%; height: 60%; object-fit: contain; }
    .slot-empty-icon { color: var(--border-hover); font-size: 24px; }
    .slot-box:hover .slot-empty-icon { color: var(--accent); }
    
    .slot-status-tag { position: absolute; bottom: 5px; left:0; width:100%; text-align: center; font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); pointer-events: none; }
    .pending .slot-status-tag { color: var(--yellow); }
    .approved .slot-status-tag { color: var(--success); display: none; }

    .slot-del-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(239, 68, 68, 0.8); display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; color: white; font-weight: 900; font-size: 12px; }
    .slot-box.filled:hover .slot-del-overlay { opacity: 1; }

    .upload-area-styled { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; animation: slideDown 0.3s ease-out; max-width: 600px; margin: 0 auto; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .form-group input, .form-group select, .modal-content input, .manage-section input { width: 100%; background: #020617; border: 1px solid var(--border-hover); padding: 14px 16px; border-radius: 12px; color: white; font-family: 'Outfit', sans-serif; font-size: 14px; transition: all 0.2s ease; outline: none; }
    .form-group input:focus, .form-group select:focus, .modal-content input:focus { border-color: var(--accent); background: #0f172a; box-shadow: 0 0 0 3px var(--accent-glow); }
    .form-group select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: var(--text-muted); font-size: 12px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 4px; }
    .emote-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group.full-width { grid-column: span 2; }

    .file-drop-zone { border: 2px dashed var(--border-hover); border-radius: 16px; padding: 30px; text-align: center; background: rgba(15, 23, 42, 0.5); transition: 0.2s; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
    .file-drop-zone:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.05); }
    .file-drop-zone input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
    .file-info { font-weight: 600; color: var(--text); pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 13px; }
    .file-info i { font-size: 24px; color: var(--accent); margin-bottom: 5px; }

    .vote-controls { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
    .vote-btn { background: #1e293b; border: 1px solid var(--border); color: #94a3b8; padding: 5px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; font-size: 13px; font-weight: 600; }
    .vote-btn:hover { background: #334155; color: white; }
    .vote-btn.active.up { color: var(--success); border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
    .vote-btn.active.down { color: var(--danger); border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
    .author-link { color: var(--accent); cursor: pointer; font-weight: bold; text-decoration: underline; }

    .collection-stats-btn { position: absolute; bottom: 20px; right: 40px; background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); padding: 8px 16px; border-radius: 12px; cursor: pointer; color: var(--text-muted); font-weight: 800; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.2s; z-index: 15; backdrop-filter: blur(5px); }
    .collection-stats-btn:hover { background: var(--panel); color: white; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .encyclo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 20px; max-height: 400px; overflow-y: auto; }
    .encyclo-item { background: #020617; border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; opacity: 0.3; filter: grayscale(1); transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; }
    .encyclo-item.owned { opacity: 1; filter: grayscale(0); border-color: var(--success); box-shadow: 0 0 15px rgba(34, 197, 94, 0.1); background: rgba(34, 197, 94, 0.02); }
    .encyclo-name { font-size: 10px; font-weight: 700; color: white; margin-top: 10px; text-transform: uppercase; }

    /* ADMIN SHOP MANAGER STYLES */
    .admin-shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
    .admin-shop-card { background: #0f172a; border: 1px solid var(--border); padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; }
    .admin-shop-card img { width: 40px; height: 40px; object-fit: contain; }
    .admin-shop-card .preview-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #020617; border-radius: 8px; font-weight: 900; font-size: 16px; }
    .admin-shop-info { flex: 1; }
    .admin-shop-name { font-size: 12px; font-weight: 700; color: white; margin-bottom: 5px; }
    .admin-shop-price-input { background: #1e293b; border: 1px solid var(--border); color: white; padding: 5px; border-radius: 6px; width: 80px; font-size: 11px; }
    
    /* ADMIN QUEUE STYLES (FIXED) */
    .admin-grid-full { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .admin-card-full { background: #0f172a; border: 1px solid var(--border); padding: 20px; border-radius: 16px; display: flex; flex-direction: column; gap: 15px; align-items: center; text-align: center; }
    
    /* FIX: Small blurred images */
    .admin-card-full img { 
        max-height: 100px; 
        max-width: 100%; 
        object-fit: contain; 
        filter: blur(10px); 
        transition: 0.3s; 
        cursor: pointer; 
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
    }
    .admin-card-full img:hover { filter: blur(0); }

    .admin-actions { display: flex; gap: 10px; width: 100%; }
    .btn-adm { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 11px; }
    .btn-approve { background: var(--success); color: black; }
    .btn-reject { background: #334155; color: white; }
    .btn-ban-user { background: var(--danger); color: white; font-weight: 900; }

    /* BANNED SCREEN */
    .banned-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--danger); }
    .banned-screen i { font-size: 80px; margin-bottom: 20px; }
    .banned-screen h1 { font-size: 40px; font-weight: 900; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
    .banned-screen p { color: var(--text-muted); margin-top: 10px; font-size: 14px; }

    /* TOGGLE SWITCH */
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* BATTLEPASS STYLES */
    .bp-header { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 15px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
    .bp-level-circle { width: 50px; height: 50px; border-radius: 50%; background: var(--twitch); border: 3px solid #0f172a; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; color: white; box-shadow: 0 0 20px rgba(145, 70, 255, 0.4); position: relative; z-index: 2; flex-shrink: 0; }
    .bp-progress-container { flex: 1; position: relative; }
    .bp-progress-bar-bg { height: 10px; background: #334155; border-radius: 10px; overflow: hidden; }
    .bp-progress-fill { height: 100%; background: linear-gradient(90deg, var(--twitch), #d946ef); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(145, 70, 255, 0.5); }
    .bp-xp-text { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-top: 6px; text-transform: uppercase; display: flex; justify-content: space-between; }
    
    .bp-claim-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 900; font-size: 13px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); transition: 0.2s; min-width: 140px; text-transform: uppercase; letter-spacing: 1px; animation: pulseGreen 2s infinite; }
    .bp-claim-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); }
    .bp-claim-btn:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; box-shadow: none; animation: none; transform: none; }
    @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

    .bp-track-container { overflow-x: auto; padding: 20px 30px; display: flex; gap: 0; position: relative; margin: 30px -30px 0 -30px; }
    .bp-track-container::-webkit-scrollbar { height: 8px; }
    .bp-track-container::-webkit-scrollbar-track { background: #0f172a; border-radius: 4px; }
    .bp-track-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    
    .bp-step { display: flex; flex-direction: column; align-items: center; min-width: 110px; position: relative; }
    .bp-step::after { content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 4px; background: #334155; z-index: 0; transform: translateY(-50%); }
    .bp-step:last-child::after { display: none; }
    
    .bp-node-free { width: 70px; height: 70px; background: #1e293b; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; transition: 0.2s; cursor: pointer; }
    .bp-node-premium { width: 70px; height: 70px; background: linear-gradient(135deg, #422006, #1e1b4b); border: 2px solid var(--yellow); border-radius: 12px; margin-top: 30px; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; transition: 0.2s; cursor: pointer; box-shadow: 0 0 10px rgba(250, 204, 21, 0.1); }
    
    .bp-node-free:hover, .bp-node-premium:hover { transform: scale(1.1); z-index: 10; }
    .bp-node-img { width: 40px; height: 40px; object-fit: contain; }
    
    .bp-level-indicator { width: 30px; height: 30px; background: #0f172a; border: 2px solid var(--text-muted); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; color: var(--text-muted); z-index: 2; }
    .bp-step.completed .bp-level-indicator { background: var(--success); border-color: var(--success); color: black; }
    .bp-step.completed::after { background: var(--success); }
    
    .bp-lock-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: rgba(255,255,255,0.5); }
    .bp-premium-tag { position: absolute; bottom: -20px; font-size: 9px; color: var(--yellow); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
    .bp-free-tag { position: absolute; top: -20px; font-size: 9px; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }

    .bp-reward-claimed { opacity: 0.5; filter: grayscale(1); }
    .bp-reward-claimed::before { content:'✔'; position:absolute; font-size:30px; color:var(--success); font-weight:900; text-shadow: 0 0 5px black; z-index:5; }

    .premium-active-banner { background: linear-gradient(90deg, var(--yellow), #f59e0b); color: black; padding: 5px 10px; border-radius: 4px; font-weight: 900; font-size: 10px; text-transform: uppercase; display: inline-block; margin-left: 10px; }

    .hidden { display: none !important; }
    
    .page-bottom-glow {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 12vh;
        background: linear-gradient(to top, rgba(145, 70, 255, 0.12) 0%, rgba(145, 70, 255, 0.04) 50%, rgba(145, 70, 255, 0) 100%);
        pointer-events: none;
        z-index: 1;
    }

    /* NEW EMOTES LAYOUT STYLES */
    .emotes-layout-container { display: flex; gap: 25px; align-items: flex-start; }
    .emotes-sidebar { width: 200px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; position: sticky; top: 80px; }
    .emotes-main-content { flex: 1; }
    
    .sidebar-btn { 
        width: 100%; text-align: left; padding: 12px 16px; 
        background: transparent; border: 1px solid transparent; 
        color: var(--text-muted); border-radius: 12px; 
        font-weight: 700; cursor: pointer; transition: 0.2s; 
        display: flex; align-items: center; gap: 12px; font-size: 13px;
    }
    .sidebar-btn:hover { background: rgba(255,255,255,0.05); color: white; }
    .sidebar-btn.active { background: var(--panel); border-color: var(--border); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .sidebar-btn.active i { color: var(--accent); }
    
    .sidebar-divider { height: 1px; background: var(--border); margin: 15px 0; width: 100%; }
    
    .btn-add-sidebar {
        width: 100%; background: var(--twitch); color: white; border: none; 
        padding: 14px; border-radius: 12px; font-weight: 800; 
        cursor: pointer; display: flex; align-items: center; justify-content: center; 
        gap: 8px; transition: 0.2s; box-shadow: 0 4px 15px rgba(145, 70, 255, 0.25); 
        font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-add-sidebar:hover { background: #772ce8; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(145, 70, 255, 0.4); }

    .sidebar-search { position: relative; margin-bottom: 5px; }
    .sidebar-search input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 10px 10px 10px 35px; border-radius: 12px; color: white; font-size: 13px; outline: none; transition: 0.2s; }
    .sidebar-search input:focus { border-color: var(--accent); background: rgba(0,0,0,0.2); }
    .sidebar-search i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; }

    .sidebar-sub-menu { display: none; flex-direction: column; gap: 4px; margin-left: 10px; padding-left: 10px; border-left: 2px solid var(--border); margin-top: 5px; animation: slideDown 0.2s ease-out; }
    .sidebar-sub-btn { text-align: left; background: transparent; border: none; color: var(--text-muted); padding: 8px 12px; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
    .sidebar-sub-btn:hover { color: white; background: rgba(255,255,255,0.05); }
    .sidebar-sub-btn.active { color: var(--accent); background: rgba(56, 189, 248, 0.1); }
    .sidebar-sub-btn.active i { color: var(--accent); }

    /* PAGINATION STYLES */
    .pagination-controls { display: flex; justify-content: center; gap: 8px; margin-top: 30px; padding-bottom: 20px; flex-wrap: wrap; }
    .page-btn { background: var(--panel); border: 1px solid var(--border); color: var(--text-muted); min-width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 13px; padding: 0 10px; }
    .page-btn:hover { background: #1e293b; color: white; border-color: var(--text-muted); }
    .page-btn.active { background: var(--twitch); color: white; border-color: var(--twitch); box-shadow: 0 4px 15px rgba(145, 70, 255, 0.3); }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
</style>
</head>
<body>

<!-- BANNED OVERLAY -->
<div id="bannedScreen" class="banned-screen">
    <i class="fas fa-ban"></i>
    <h1>ZBANOWANY</h1>
    <p>Twój dostęp do panelu Gato.TV został zablokowany przez administratora.</p>
</div>

<header>
    <div class="header-left">
        <div class="logo" onclick="location.reload()">Gato.TV <span class="beta-tag">BETA</span></div>
        <div id="loginBtnContainer">
            <button class="btn-login-header" onclick="loginAsGuest()">Zaloguj (Gość)</button>
        </div>
        <div class="search-container" id="searchContainer" style="display:none;">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="userSearchInput" class="search-input" placeholder="Szukaj profilu...">
        </div>
    </div>
    <div style="display:flex; align-items:center;">
        <div id="coinDisplay" class="coin-display" style="display:none;" onclick="switchTab('premium')">
            <i class="fas fa-coins"></i> <span id="coinCount">...</span>
        </div>
        <nav>
            <button class="active" onclick="switchTab('profile')">Profile</button>
            <button onclick="switchTab('shop')">Shop</button>
            <button onclick="switchTab('emotes')">Emotes</button>
            <button class="btn-purple" onclick="switchTab('premium')">Premium</button>
            <button class="btn-yellow" onclick="switchTab('download')">Download</button>
        </nav>
    </div>
</header>

<div class="container">

    <!-- PROFILE TAB -->
    <div id="profile" class="panel active">
        <div class="login-blocker">
            <div class="lb-icon-box"><i class="fas fa-lock"></i></div>
            <div class="lb-title">Dostęp Ograniczony</div>
            <div class="lb-desc">Ta sekcja wymaga zalogowania. Zaloguj się, aby uzyskać pełny dostęp do funkcjonalności serwisu.</div>
            <div class="login-options">
                <button class="btn-login-option btn-twitch" onclick="loginWithTwitch()"><i class="fab fa-twitch"></i> Twitch</button>
                <button class="btn-login-option btn-kick" onclick="loginAsGuest()"><i class="fab fa-kickstarter"></i> Kick (Gość)</button>
            </div>
            <div class="secure-badge"><i class="fas fa-check-circle"></i> Bezpieczne Logowanie</div>
        </div>
        <div class="protected-content">
            <div class="profile-header">
                <button id="btnBackToMe" class="back-to-me-btn" onclick="returnToMyProfile()">WRÓĆ DO SIEBIE</button>
                <div class="profile-banner">
                    <div class="profile-nav-centered">
                        <button id="pTabInv" class="active" onclick="switchProfileSubTab('inventory')"><i class="fas fa-briefcase"></i> Ekwipunek</button>
                        <button id="pTabCh" onclick="switchProfileSubTab('channel')"><i class="fas fa-tv"></i> Emotes Menu</button>
                    </div>
                </div>
                <!-- LICZNIK KOLEKCJI -->
                <div id="collectionStats" class="collection-stats-btn" onclick="openEncyclopedia()" style="display:none;">
                    <i class="fas fa-book"></i> Collection <span id="collectionCount" style="margin-left:2px;">...</span>
                </div>

                <div class="profile-meta-container">
                    <img id="profileAvatarBig" class="profile-avatar-big" src="">
                    <div class="profile-info-block">
                        <div class="profile-name-row" style="display:flex; align-items:center; gap:10px;">
                            <div id="profileNameBig" class="profile-name-big">...</div>
                            <span id="viewingBadge" class="viewing-badge" style="display:none;">PODGLĄD</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div id="profileRoleTag" class="profile-role-tag">USER</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-content-area">

                <div id="profileInventory" style="display:block;">
                    <div class="inventory-header">
                        <div class="inv-title-box">
                            <div class="inv-icon"><i class="fas fa-layer-group"></i></div>
                            <div>
                                <h2>Twoja Kolekcja</h2>
                                <p>Zarządzaj swoimi przedmiotami</p>
                            </div>
                        </div>
                        <div class="inv-controls">
                            <div class="search-wrapper">
                                <i class="fas fa-search"></i>
                                <input type="text" id="invSearch" placeholder="Szukaj..." oninput="renderProfileInventory()">
                            </div>
                        </div>
                    </div>
                    <div class="inv-filters">
                        <button class="filter-btn active" onclick="setInvFilter('all')" id="fBtn_all">Wszystkie</button>
                        <button class="filter-btn" onclick="setInvFilter('paint')" id="fBtn_paint">Painty</button>
                        <button class="filter-btn" onclick="setInvFilter('badge')" id="fBtn_badge">Odznaki</button>
                        <button class="filter-btn" onclick="setInvFilter('fav')" id="fBtn_fav"><i class="fas fa-heart"></i> Ulubione</button>
                    </div>
                    <div id="profileInvGrid" class="inventory-grid"></div>
                </div>
                <div id="profileChannel" style="display:none;">
                    <div class="emote-sub-nav" style="justify-content: center; margin-bottom: 20px;">
                        <button id="pemBtn1" class="active" onclick="switchEmoteMenuTab(1)">On Channel</button>
                        <button id="pemBtn2" onclick="switchEmoteMenuTab(2)">Personal (5)</button>
                        <button id="pemBtn3" onclick="switchEmoteMenuTab(3)">Uploaded</button>
                        <button id="pemBtn4" onclick="switchEmoteMenuTab(4)">7TV Emotes</button>
                    </div>

                    <div id="pemContent1">
                        <div class="profile-section-title"><i class="fas fa-hashtag"></i> Przypisane do Kanału</div>
                        <div id="profileChannelGrid" class="emotes-grid"></div>
                    </div>
                    <div id="pemContent2" style="display:none;">
                        <div class="profile-section-title"><i class="fas fa-star"></i> Personal Emotes (Global)</div>
                        <p style="color:#94a3b8; font-size:12px; text-align:center; margin-bottom:20px;">Wybierz do 5 emotek, które będą dostępne dla Ciebie na każdym kanale.</p>
                        <div id="personalEmotesGrid" class="emote-slots-bar" style="justify-content:center; gap:15px; grid-template-columns: repeat(5, 60px); max-width: 450px; margin: 0 auto;"></div>
                    </div>
                    <div id="pemContent3" style="display:none;">
                        <div class="profile-section-title"><i class="fas fa-cloud-upload-alt"></i> Przesłane przeze mnie</div>
                        <div id="myUploadedGrid" class="emotes-grid"></div>
                    </div>
                    <div id="pemContent4" style="display:none;">
                        <div class="profile-section-title"><i class="fas fa-tv"></i> 7TV Emotes</div>
                        <div id="input7tvArea" style="display:flex; gap:10px; margin-bottom:15px;">
                            <input id="input7tvPanel" placeholder="Wklej ID Emote Setu (np. 60b0...)" style="flex:1; background:#020617; border:1px solid #1e293b; color:white; padding:10px; border-radius:8px;">
                            <button class="btn-primary" style="width:auto;" onclick="load7tvInPanel()">ŁADUJ</button>
                        </div>
                        <div id="status7tvArea" style="display:none; justify-content:space-between; align-items:center; margin-bottom:15px; background:rgba(34, 197, 94, 0.1); border:1px solid #22c55e; padding:10px 15px; border-radius:8px;">
                            <div style="color:#22c55e; font-weight:800; font-size:13px; display:flex; align-items:center; gap:8px;">
                                <i class="fas fa-check-circle"></i> <span id="status7tvText">SET ZAŁADOWANY</span>
                            </div>
                            <button class="btn-secondary" style="background:#ef4444; color:white; font-size:11px; padding:6px 12px;" onclick="disconnect7tv()">ODŁĄCZ</button>
                        </div>
                        <div id="panel7tvGrid" class="emotes-grid"></div>
                    </div>
                </div>
    </div>
    </div>
    </div>

    <!-- SHOP TAB -->
    <div id="shop" class="panel">
        <div class="login-blocker">
            <div class="lb-icon-box"><i class="fas fa-lock"></i></div>
            <div class="lb-title">Dostęp Ograniczony</div>
            <div class="lb-desc">Ta sekcja wymaga zalogowania. Zaloguj się, aby uzyskać pełny dostęp do funkcjonalności serwisu.</div>
            <div class="login-options">
                <button class="btn-login-option btn-twitch" onclick="loginWithTwitch()"><i class="fab fa-twitch"></i> Twitch</button>
                <button class="btn-login-option btn-kick" onclick="loginAsGuest()"><i class="fab fa-kickstarter"></i> Kick (Gość)</button>
            </div>
            <div class="secure-badge"><i class="fas fa-check-circle"></i> Bezpieczne Logowanie</div>
        </div>
        <div class="protected-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-weight:900; letter-spacing:-1px; font-size:28px;">Sklep Gato.TV</h2>
                <button id="btnDaily" class="btn-daily" onclick="claimDailyBonus()"><i class="fas fa-gift"></i> ŁADOWANIE...</button>
            </div>
            
            <div style="margin-bottom:30px;">
                <div class="chat-preview-container">
                    <div class="chat-line">
                        <span class="chat-time">12:30</span>
                        <span class="chat-badges preview-badges"></span>
                        <span class="chat-username preview-user">TwójNick</span><span style="margin-right:4px;">:</span><span class="chat-msg">Podgląd na żywo! Wybierz coś dla siebie. ✨</span>
                    </div>
                    <button class="preview-theme-btn" onclick="togglePreviewTheme(this.parentElement)" title="Zmień motyw">
                        <i class="fas fa-adjust"></i>
                    </button>
                </div>
            </div>

            <div id="shopContent"></div>
        </div>
    </div>

    <!-- EMOTES -->
    <div id="emotes" class="panel">
        <div class="login-blocker">
            <div class="lb-icon-box"><i class="fas fa-lock"></i></div>
            <div class="lb-title">Dostęp Ograniczony</div>
            <div class="lb-desc">Ta sekcja wymaga zalogowania. Zaloguj się, aby uzyskać pełny dostęp do funkcjonalności serwisu.</div>
            <div class="login-options">
                <button class="btn-login-option btn-twitch" onclick="loginWithTwitch()"><i class="fab fa-twitch"></i> Twitch</button>
                <button class="btn-login-option btn-kick" onclick="loginAsGuest()"><i class="fab fa-kickstarter"></i> Kick (Gość)</button>
            </div>
            <div class="secure-badge"><i class="fas fa-check-circle"></i> Bezpieczne Logowanie</div>
        </div>
        <div class="protected-content">
            <!-- GALLERY VIEW -->
            <div id="emotesGalleryView">
                <div class="emotes-layout-container">
                    <!-- SIDEBAR -->
                    <div class="emotes-sidebar">
                        <h2 style="margin:0 0 15px 5px; font-weight:900; letter-spacing:-1px; font-size: 22px; color:white;">Emotki</h2>
                        
                        <div class="sidebar-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="emoteSidebarSearch" placeholder="Szukaj emotek" oninput="AppState.emotePage=1; renderEmotes()">
                        </div>
                        
                        <button id="tabGlobal" class="sidebar-btn active" onclick="setEmoteTab('global')">
                            <i class="fas fa-globe"></i> GLOBAL
                        </button>
                        <button id="tabUsers" class="sidebar-btn" onclick="setEmoteTab('users')">
                            <i class="fas fa-users"></i> USERS
                        </button>

                        <div id="usersSubMenu" class="sidebar-sub-menu">
                            <button id="sortNew" class="sidebar-sub-btn active" onclick="setEmoteSort('new')"><i class="fas fa-fire"></i> NEW</button>
                            <button id="sortTrending" class="sidebar-sub-btn" onclick="setEmoteSort('trending')"><i class="fas fa-chart-line"></i> TRENDING</button>
                            <button id="sortTop" class="sidebar-sub-btn" onclick="setEmoteSort('top')"><i class="fas fa-crown"></i> TOP</button>
                        </div>
                        
                        <div class="sidebar-divider"></div>

                        <button class="btn-add-sidebar" onclick="openEmoteDashboard()">
                            <i class="fas fa-plus"></i> DODAJ SWOJĄ
                        </button>
                    </div>

                    <!-- MAIN CONTENT -->
                    <div class="emotes-main-content">
                        <div id="emotesGrid" class="emotes-grid" style="margin-top:0;">Ładowanie...</div>
                        <div id="emotesPagination" class="pagination-controls"></div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED DASHBOARD VIEW -->
            <div id="emotesDashboardView" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2><i class="fas fa-layer-group"></i> Panel Twórcy</h2>
                    <button class="btn-secondary" onclick="closeEmoteDashboard()">Powrót do Galerii</button>
                </div>
                
                <div class="dashboard-full-container">
                    
                    <!-- 1. SLOTY & RULES (SPLIT LAYOUT) -->
                    <div class="dashboard-top-split">
                        <div>
                            <div style="font-size:12px; font-weight:800; color:#94a3b8; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; text-align:center;">Twoje Sloty (Max 10)</div>
                            <div id="emoteSlotsContainer" class="emote-slots-bar">
                                <!-- JS generates slots here -->
                            </div>
                        </div>
                        
                        <!-- MINI REGULAMIN -->
                        <div class="rules-box">
                            <div class="rules-title"><i class="fas fa-exclamation-triangle"></i> Zasady Uploadu</div>
                            <ul class="rules-list">
                                <li><i class="fas fa-check"></i> <span>Dozwolone: Imgur, 7TV, Catbox, Twitch CDN.</span></li>
                                <li><i class="fas fa-times"></i> <span>Zakaz: Discord (linki wygasają), SVG, NSFW.</span></li>
                                <li><i class="fas fa-link"></i> <span>Tylko bezpośrednie linki (końcówka .png, .gif, .webp).</span></li>
                                <li><i class="fas fa-shield-alt"></i> <span>Wymagane bezpieczne połączenie HTTPS.</span></li>
                            </ul>
                        </div>
                    </div>

                    <!-- 2. UPLOAD FORM -->
                    <div id="uploadFormArea" style="display:none;">
                         <div class="upload-area-styled">
                            <div style="display:flex; justify-content:space-between; margin-bottom:25px; align-items:center;">
                                <h3 style="margin:0; color:white; font-size: 20px;"><i class="fas fa-cloud-upload-alt"></i> Prześlij Emotkę</h3>
                                <button class="btn-outline" style="padding:6px 12px; font-size:11px; border-radius:8px;" onclick="closeUploadForm()">ANULUJ</button>
                            </div>
                            <div class="emote-form-grid">
                                <div class="form-group">
                                    <label>Kod Emotki</label>
                                    <input id="emoName" type="text" placeholder="Np. GatoHype">
                                </div>
                                <div class="form-group">
                                    <label>Kanał Docelowy</label>
                                    <select id="emoChannel"><option value="" disabled selected>Ładowanie...</option></select>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label>Link URL (Wymagany)</label>
                                    <input id="emoUrl" type="text" placeholder="https://...">
                                    <p style="font-size:10px; color:#64748b; margin-top:5px;">Wklej bezpośredni link do obrazka (np. z imgur.com, catbox.moe). Max 150 znaków.</p>
                                </div>
                                
                                <div id="adminScopeOption" class="form-group full-width" style="display:none;">
                                    <label style="color:var(--accent); display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="chkGlobal" style="width:auto; margin:0;"> 
                                        <span>OPCJA GLOBALNA (ADMIN)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="display:flex; align-items:center; gap:20px; margin-top:25px;">
                                <button class="btn-primary" style="flex:1; padding:14px; font-size:14px;" onclick="addEmote()">💾 Zapisz w Slocie</button>
                            </div>
                         </div>
                    </div>

                    <!-- 3. ZARZĄDZANIE -->
                    <div class="manage-section">
                        <div class="manage-header"><i class="fas fa-user-shield"></i> Zarządzanie Uprawnieniami</div>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input id="newModNick" placeholder="Nick moderatora / edytora" style="flex:1;">
                            <button class="btn-primary" style="width:auto;" onclick="addModerator()">Dodaj Uprawnienia</button>
                        </div>
                        <div id="modsList" class="mods-list-container"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- PREMIUM (WIP) -->
    <div id="premium" class="panel">
        <div class="login-blocker">
            <div class="lb-icon-box"><i class="fas fa-lock"></i></div>
            <div class="lb-title">Dostęp Ograniczony</div>
            <div class="lb-desc">Ta sekcja wymaga zalogowania. Zaloguj się, aby uzyskać pełny dostęp do funkcjonalności serwisu.</div>
            <div class="login-options">
                <button class="btn-login-option btn-twitch" onclick="loginWithTwitch()"><i class="fab fa-twitch"></i> Twitch</button>
                <button class="btn-login-option btn-kick" onclick="loginAsGuest()"><i class="fab fa-kickstarter"></i> Kick (Gość)</button>
            </div>
            <div class="secure-badge"><i class="fas fa-check-circle"></i> Bezpieczne Logowanie</div>
        </div>
        <div class="protected-content">
            <div class="wip-container">
                <i class="fas fa-hammer wip-icon"></i>
            </div>
        </div>
    </div>

    <!-- DOWNLOAD (NEW DESIGN) -->
    <div id="download" class="panel">
        <div class="download-hero">
            <h1 class="dl-title">Gato.TV Plugin</h1>
            <p class="dl-subtitle">Zmień swój czat w centrum dowodzenia. Wersja 1.0 Beta.</p>
            <button class="dl-btn-main" onclick="fireDownloadConfetti()">
                <i class="fas fa-download"></i> Pobierz Teraz
            </button>
            
            <div class="dl-features">
                <div class="dl-feat-card">
                    <div class="dl-icon"><i class="fas fa-paint-brush"></i></div>
                    <h3 style="color:white; margin:0 0 10px 0;">Personalizacja</h3>
                    <p style="color:#94a3b8; font-size:13px; margin:0;">Unikalne kolory nicków, odznaki i style widoczne dla wszystkich użytkowników wtyczki.</p>
                </div>
                <div class="dl-feat-card">
                    <div class="dl-icon"><i class="fas fa-smile"></i></div>
                    <h3 style="color:white; margin:0 0 10px 0;">Emotki 7TV+</h3>
                    <p style="color:#94a3b8; font-size:13px; margin:0;">Dostęp do globalnej bazy emotek oraz Twoich prywatnych slotów na każdym kanale.</p>
                </div>
                <div class="dl-feat-card">
                    <div class="dl-icon"><i class="fas fa-coins"></i></div>
                    <h3 style="color:white; margin:0 0 10px 0;">Ekonomia</h3>
                    <p style="color:#94a3b8; font-size:13px; margin:0;">Zbieraj monety za aktywność, kupuj unikalne przedmioty i wymieniaj się z innymi.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADMIN PANEL (FULL PAGE) -->
    <div id="admin" class="panel">
        <div class="protected-content">
            <h2 style="font-size:28px; font-weight:900; color:white; margin-bottom:30px;"><i class="fas fa-gavel"></i> Panel Moderacji</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Zatwierdzaj lub odrzucaj emotki zgłoszone przez użytkowników. Zdjęcia są domyślnie zamazane.</p>
            
            <!-- MANUAL BAN SECTION -->
            <div style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid var(--danger); margin-bottom:30px; display:flex; gap:10px; align-items:center;">
                <i class="fas fa-ban" style="color:var(--danger); font-size:24px;"></i>
                <input id="manualBanInput" placeholder="Wpisz nick do zbanowania..." style="flex:1; background:#0f172a; border:1px solid var(--border); color:white; padding:10px; border-radius:8px;">
                <button class="btn-primary" style="background:var(--danger);" onclick="banUser(document.getElementById('manualBanInput').value)">ZBANUJ</button>
            </div>

            <div id="adminQueueGrid" class="admin-grid-full">
                <!-- Content injected by JS -->
            </div>
            
            <!-- NEW: SHOP MANAGEMENT SECTION -->
            <div id="adminShopManage" style="margin-top: 50px; border-top: 1px solid var(--border); padding-top: 30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:white; margin:0;"><i class="fas fa-store"></i> Zarządzanie Ofertą Sklepu</h3>
                    <button class="btn-primary" onclick="saveShopConfig()">ZAPISZ ZMIANY</button>
                </div>
                <div id="adminShopGrid" class="admin-shop-grid"></div>
            </div>
        </div>
    </div>

</div>

<!-- BOTTOM ELEMENTS GROUPED -->
<div id="bottomLeftControls" class="fixed-bottom-controls">
    <div id="userRoleBadge" class="role-badge" style="display:none;" onclick="if(AppState.role==='ADMIN') openAdminPanel()">USER</div>
    <div id="btnConnections" class="connections-btn" style="display:none;" onclick="openConnectionsModal()">CONNECTIONS</div>
</div>

<div id="userProfileFloater" class="user-profile-floater" style="display:none;"><img id="floaterAvatar" class="floater-avatar" src=""><div class="floater-info"><span id="floaterName" class="floater-name">...</span><button class="btn-logout-mini" onclick="logout()">Wyloguj</button></div></div>

<!-- PREVIEW MOVED OUTSIDE PANEL TO FIX ANIMATION JUMP -->
<div class="chat-preview-container" id="previewContainer">
    <div class="chat-line">
        <span class="chat-time">12:30</span>
        <span class="chat-badges preview-badges"></span>
        <span class="chat-username preview-user">TwójNick</span><span style="margin-right:4px;">:</span><span class="chat-msg">Gato.TV zmienia Twój czat! 🐱</span>
    </div>
    <button class="preview-theme-btn" onclick="togglePreviewTheme(this.parentElement)" title="Zmień motyw">
        <i class="fas fa-adjust"></i>
    </button>
</div>

<div id="redeemBtn" class="redeem-btn" onclick="redeemCode()">🎁 REDEEM CODE</div>

<div class="page-bottom-glow"></div>

<!-- EMOTE MODAL -->
<div id="modalWrap" class="modal-wrap" style="display:none;">
    <div class="modal-box">
        <div class="modal-head"><button class="modal-close" onclick="closeModal()">×</button><img id="mImg" src="" style="height:80px;"></div>
        <div class="modal-content">
            <h2 id="mCode" style="color:white; margin:0;">CODE</h2>
            <p style="color:#888; font-size:12px; margin-top:5px;">Autor: <span id="mAuth" class="author-link" onclick="closeModal(); searchUserProfile(this.innerText)">Author</span></p>
            
            <div class="vote-controls">
                <button id="btnVoteUp" class="vote-btn" onclick="voteEmote(1)"><i class="fas fa-thumbs-up"></i> <span id="voteCountUp">0</span></button>
                <button id="btnVoteDown" class="vote-btn" onclick="voteEmote(-1)"><i class="fas fa-thumbs-down"></i> <span id="voteCountDown">0</span></button>
            </div>
            
            <button id="btnAddToPersonal" class="modal-btn" style="background:#38bdf8; color:#000; margin-top:10px;" onclick="addToPersonal()">DODAJ DO PERSONALNYCH (0/5)</button>

            <button class="modal-btn" style="background:#22c55e; color:#fff;" onclick="assignEmote()">PRZYPISZ DO KANAŁU</button>
        </div>
    </div>
</div>

<!-- ENCYCLOPEDIA MODAL -->
<div id="modalEncyclopedia" class="modal-wrap" style="display:none;">
    <div class="modal-box" style="max-width: 600px;">
        <div class="modal-head" style="padding: 20px;">
            <button class="modal-close" onclick="document.getElementById('modalEncyclopedia').style.display='none'" style="top:15px; right:15px;">×</button>
            <h2 style="margin:0; font-size:18px; color:white;">ENCYKLOPEDIA KOLEKCJI</h2>
        </div>
        <div id="encyclopediaGrid" class="encyclo-grid"></div>
    </div>
</div>

<!-- CONNECTIONS MODAL -->
<div id="modalConnections" class="modal-wrap" style="display:none;">
    <div class="modal-box" style="max-width: 350px;">
        <div class="modal-head" style="padding: 20px;">
            <button class="modal-close" onclick="closeConnectionsModal()" style="top:15px; right:15px;">×</button>
            <h2 style="margin:0; font-size:18px; color:white;">CONNECTIONS</h2>
        </div>
        <div class="modal-content" style="padding: 20px; text-align: left;">
            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:5px; color:#53fc18;">Kick Integration</label>
                <input id="kickNickInputModal" placeholder="Twój nick na Kick..." style="padding:10px; font-size:13px;">
                <p style="font-size:10px; color:#666; margin-top:5px;">Po wpisaniu nicku Twój ekwipunek będzie synchronizowany.</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary small" style="flex:1; background:#53fc18; color:black;" onclick="saveKickNick()">ZAPISZ</button>
                <button class="btn-secondary small" style="flex:1; background:var(--danger);" onclick="deleteKickNick()">USUŃ</button>
            </div>
        </div>
    </div>
</div>

<script>
// CONFIG
const CLIENT_ID = 'l0agnxl8yeto7wda5wvblpg1mr55db';
const REDIRECT_URI = 'https://gatotv.github.io/panel/';
const DB_URL = "https://wersjabeta-8cf8c-default-rtdb.europe-west1.firebasedatabase.app/";

// STATE
let AppState = { 
    user: null, 
    token: null, 
    coins: 0, 
    owned: [], 
    loadout: {}, 
    emotes: {}, 
    allowedChannels: [], 
    role: "USER", 
    emoteTab: 'global', 
    emoteSort: 'new', 
    currentEmoteKey: null, 
    currentEmoteData: null, 
    viewingUser: null, 
    kickNick: null,
    lastDaily: 0,
    shopActive: {},
    bpXp: 0,
    lastBpClaim: 0,
    hasPremium: false, // Symulacja premium
    favorites: [],
    invFilter: 'all', 
    personalEmotes: [],
    emotePage: 1,
    sevenTvId: null
};

// CATALOG (Visuals Only - Prices are in API)
const CATALOG = [
    {
        name: "Swag ponad Swag bratku",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(90deg, rgb(208, 78, 78) 0%, rgb(151, 88, 202) 18%, rgb(73, 113, 208) 34%, rgb(0, 255, 251) 54%, rgb(0, 255, 4) 70%, rgb(251, 255, 0) 87%, rgb(255, 115, 0) 100%)",
        filter: "drop-shadow(rgb(255, 0, 0) 0px 0px 1px) drop-shadow(rgb(251, 0, 255) 0px 0px 1px) drop-shadow(rgb(43, 0, 255) 0px 0px 1px) drop-shadow(rgb(0, 255, 238) 0px 0px 1px) drop-shadow(rgb(0, 255, 51) 0px 0px 1px) drop-shadow(rgb(200, 255, 0) 0px 0px 1px) drop-shadow(rgb(255, 123, 0) 0px 0px 1px) drop-shadow(rgb(255, 0, 0) 0px 0px 1px)",
        previewStyle: "background-image: linear-gradient(90deg, rgb(208, 78, 78) 0%, rgb(151, 88, 202) 18%, rgb(73, 113, 208) 34%, rgb(0, 255, 251) 54%, rgb(0, 255, 4) 70%, rgb(251, 255, 0) 87%, rgb(255, 115, 0) 100%); filter: drop-shadow(rgb(255, 0, 0) 0px 0px 1px) drop-shadow(rgb(251, 0, 255) 0px 0px 1px) drop-shadow(rgb(43, 0, 255) 0px 0px 1px) drop-shadow(rgb(0, 255, 238) 0px 0px 1px) drop-shadow(rgb(0, 255, 51) 0px 0px 1px) drop-shadow(rgb(200, 255, 0) 0px 0px 1px) drop-shadow(rgb(255, 123, 0) 0px 0px 1px) drop-shadow(rgb(255, 0, 0) 0px 0px 1px); -webkit-background-clip: text; color: transparent; background-size: 200% auto; animation: gatoShine 3s linear infinite; font-weight: 900;"
    },
    { 
        name: "King Crown", 
        category: "badge", 
        type: "badge", 
        value: "https://cdn-icons-png.flaticon.com/128/2545/2545603.png", 
        previewStyle: "" 
    },
    {
        name: "Lunar Lantern",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(90deg, rgb(200, 35, 40) 1%, rgb(250, 170, 40) 20%, rgb(255, 215, 75) 40%, rgb(245, 135, 140) 60%, rgb(160, 40, 40) 80%, rgb(200, 150, 5) 99%)",
        filter: "drop-shadow(rgba(255, 40, 40, 0.255) 0.55px 0px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) -0.55px 0px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) 0px 0.55px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) 0px -0.55px 0.86px)",
        previewStyle: "background-image: linear-gradient(90deg, rgb(200, 35, 40) 1%, rgb(250, 170, 40) 20%, rgb(255, 215, 75) 40%, rgb(245, 135, 140) 60%, rgb(160, 40, 40) 80%, rgb(200, 150, 5) 99%); filter: drop-shadow(rgba(255, 40, 40, 0.255) 0.55px 0px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) -0.55px 0px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) 0px 0.55px 0.86px) drop-shadow(rgba(255, 40, 40, 0.255) 0px -0.55px 0.86px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Fairy Glow",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(90deg, rgb(255, 164, 182) 0%, rgb(255, 255, 255) 20%, rgb(255, 164, 182) 40%, rgb(255, 255, 255) 60%, rgb(255, 164, 182) 80%, rgb(255, 255, 255) 100%)",
        filter: "drop-shadow(rgb(221, 90, 160) 0px 0px 8px)",
        previewStyle: "background-image: linear-gradient(90deg, rgb(255, 164, 182) 0%, rgb(255, 255, 255) 20%, rgb(255, 164, 182) 40%, rgb(255, 255, 255) 60%, rgb(255, 164, 182) 80%, rgb(255, 255, 255) 100%); filter: drop-shadow(rgb(221, 90, 160) 0px 0px 8px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Summer",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(150deg, rgb(92, 81, 217) 20%, rgb(227, 81, 151) 49%, rgb(253, 183, 27) 80%)",
        filter: "drop-shadow(rgb(255, 20, 224) 0px 0px 5px)",
        previewStyle: "background-image: linear-gradient(150deg, rgb(92, 81, 217) 20%, rgb(227, 81, 151) 49%, rgb(253, 183, 27) 80%); filter: drop-shadow(rgb(255, 20, 224) 0px 0px 5px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Uranium",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(238, 255, 0) 0%, rgb(166, 255, 0) 50%, rgb(93, 195, 9) 100%)",
        filter: "drop-shadow(rgb(37, 50, 1) 0px 0px 0.5px) drop-shadow(rgb(189, 225, 9) 0px 0px 4px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(238, 255, 0) 0%, rgb(166, 255, 0) 50%, rgb(93, 195, 9) 100%); filter: drop-shadow(rgb(37, 50, 1) 0px 0px 0.5px) drop-shadow(rgb(189, 225, 9) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Anodized old",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(255, 175, 77) 0%, rgb(255, 102, 102) 20%, rgb(246, 66, 255) 31%, rgb(51, 102, 255) 55%, rgb(66, 208, 255) 80%, rgb(88, 254, 151) 100%)",
        filter: "drop-shadow(rgb(211, 56, 220) 0px 0px 0.1px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(255, 175, 77) 0%, rgb(255, 102, 102) 20%, rgb(246, 66, 255) 31%, rgb(51, 102, 255) 55%, rgb(66, 208, 255) 80%, rgb(88, 254, 151) 100%); filter: drop-shadow(rgb(211, 56, 220) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Neon Pastel GB",
        category: "paint",
        type: "gradient",
        value: "url('https://cdn.7tv.app/paint/01GKMJA3WR00096MBH3JZ33RK9/layer/01JAMR24N93C229RFJFH0M53D5/1x.webp')",
        filter: "drop-shadow(rgb(77, 210, 255) 0px 0px 1px) drop-shadow(rgb(238, 0, 255) 0px 0px 2px) drop-shadow(rgb(59, 22, 146) 0px 0px 1px)",
        previewStyle: "background-image: url('https://cdn.7tv.app/paint/01GKMJA3WR00096MBH3JZ33RK9/layer/01JAMR24N93C229RFJFH0M53D5/1x.webp'); filter: drop-shadow(rgb(77, 210, 255) 0px 0px 1px) drop-shadow(rgb(238, 0, 255) 0px 0px 2px) drop-shadow(rgb(59, 22, 146) 0px 0px 1px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Rastafari oA",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(166deg, rgb(255, 15, 15) 30%, rgb(255, 237, 41) 55%, rgb(0, 194, 32) 75%)",
        filter: "drop-shadow(rgb(0, 148, 2) 0px 0px 4px)",
        previewStyle: "background-image: linear-gradient(166deg, rgb(255, 15, 15) 30%, rgb(255, 237, 41) 55%, rgb(0, 194, 32) 75%); filter: drop-shadow(rgb(0, 148, 2) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;"
    },
    {
        name: "Classic",
        category: "badge",
        type: "badge",
        value: "https://i.postimg.cc/0y9k3HQD/1.png",
        previewStyle: ""
    },
    {
        name: "Sunset",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(90deg, rgb(255, 170, 100) 0%, rgb(160, 25, 115) 50%, rgb(70, 10, 140) 100%)",
        filter: "drop-shadow(rgb(160, 25, 115) 0px 0px 0.1px)",
        previewStyle: "background-image: linear-gradient(90deg, rgb(255, 170, 100) 0%, rgb(160, 25, 115) 50%, rgb(70, 10, 140) 100%); filter: drop-shadow(rgb(160, 25, 115) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Reverberate oA",
        category: "paint",
        type: "gradient",
        value: "repeating-linear-gradient(51deg, rgb(78, 100, 188) 0%, rgb(83, 67, 174) 13%, rgb(122, 21, 155) 21%, rgb(183, 44, 140) 29%, rgb(208, 89, 58) 35%, rgb(236, 175, 85) 50%)",
        filter: "drop-shadow(rgb(0, 42, 255) 0px 0px 4px)",
        previewStyle: "background-image: repeating-linear-gradient(51deg, rgb(78, 100, 188) 0%, rgb(83, 67, 174) 13%, rgb(122, 21, 155) 21%, rgb(183, 44, 140) 29%, rgb(208, 89, 58) 35%, rgb(236, 175, 85) 50%); filter: drop-shadow(rgb(0, 42, 255) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Cherry oA",
        category: "paint",
        type: "gradient",
        value: "repeating-linear-gradient(61deg, rgb(255, 36, 36) 0%, rgb(204, 0, 0) 10%, rgb(90, 7, 7) 20%, rgb(179, 0, 0) 27%, rgb(92, 5, 5) 35%, rgb(255, 31, 31) 50%)",
        filter: "drop-shadow(rgb(153, 0, 0) 0px 0px 5px)",
        previewStyle: "background-image: repeating-linear-gradient(61deg, rgb(255, 36, 36) 0%, rgb(204, 0, 0) 10%, rgb(90, 7, 7) 20%, rgb(179, 0, 0) 27%, rgb(92, 5, 5) 35%, rgb(255, 31, 31) 50%); filter: drop-shadow(rgb(153, 0, 0) 0px 0px 5px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Black Hole G",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(0deg, #000, #000)",
        filter: "drop-shadow(rgb(255, 255, 255) 0px 0px 1px) drop-shadow(rgb(0, 0, 0) 0px 3px 4px)",
        previewStyle: "background-image: linear-gradient(0deg, #000, #000); filter: drop-shadow(rgb(255, 255, 255) 0px 0px 1px) drop-shadow(rgb(0, 0, 0) 0px 3px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Celebration oA",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(rgb(254, 62, 219) 25%, rgb(90, 31, 255) 45%, rgb(48, 20, 255) 55%, rgb(72, 36, 255) 69%, rgb(102, 0, 255) 100%)",
        filter: "drop-shadow(rgb(115, 0, 255) 0px 1px 0.1px) drop-shadow(rgb(43, 0, 255) 0.01px 0.01px 4.01px)",
        previewStyle: "background-image: radial-gradient(rgb(254, 62, 219) 25%, rgb(90, 31, 255) 45%, rgb(48, 20, 255) 55%, rgb(72, 36, 255) 69%, rgb(102, 0, 255) 100%); filter: drop-shadow(rgb(115, 0, 255) 0px 1px 0.1px) drop-shadow(rgb(43, 0, 255) 0.01px 0.01px 4.01px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Butterscotch",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(135deg, rgb(254, 206, 32) 10%, rgb(131, 28, 13) 20%, rgb(128, 30, 30) 30%, rgb(254, 219, 42) 50%, rgb(146, 32, 32) 60%, rgb(140, 8, 8) 70%, rgb(254, 206, 32) 90%)",
        filter: "drop-shadow(rgb(162, 73, 57) 0px 0px 0.1px)",
        previewStyle: "background-image: linear-gradient(135deg, rgb(254, 206, 32) 10%, rgb(131, 28, 13) 20%, rgb(128, 30, 30) 30%, rgb(254, 219, 42) 50%, rgb(146, 32, 32) 60%, rgb(140, 8, 8) 70%, rgb(254, 206, 32) 90%); filter: drop-shadow(rgb(162, 73, 57) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "900",
        category: "paint",
        type: "gradient",
        value: "url('https://cdn.7tv.app/paint/01KA84S7GDS77JGK2RRG7ZZ946/layer/01KAMWGXF22HF19PMHFB34ET2A/1x.webp')",
        filter: "drop-shadow(rgb(196, 139, 9) 0px 0px 3.5px)",
        previewStyle: "background-image: url('https://cdn.7tv.app/paint/01KA84S7GDS77JGK2RRG7ZZ946/layer/01KAMWGXF22HF19PMHFB34ET2A/1x.webp'); filter: drop-shadow(rgb(196, 139, 9) 0px 0px 3.5px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Shortcake",
        category: "paint",
        type: "gradient",
        value: "repeating-radial-gradient(circle, rgb(255, 138, 245) 0%, rgb(254, 88, 232) 20%, rgb(145, 76, 59) 37%, rgb(171, 93, 79) 49%, rgb(254, 247, 200) 72%, rgb(255, 242, 158) 100%)",
        filter: "drop-shadow(rgb(122, 59, 145) 0px 0px 0.1px)",
        previewStyle: "background-image: repeating-radial-gradient(circle, rgb(255, 138, 245) 0%, rgb(254, 88, 232) 20%, rgb(145, 76, 59) 37%, rgb(171, 93, 79) 49%, rgb(254, 247, 200) 72%, rgb(255, 242, 158) 100%); filter: drop-shadow(rgb(122, 59, 145) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Disco Classic",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(252, 232, 215) 0%, rgb(255, 232, 215) 25%, rgb(240, 83, 70) 25%, rgb(240, 83, 70) 50%, rgb(244, 173, 23) 50%, rgb(244, 173, 23) 75%, rgb(41, 162, 205) 75%, rgb(41, 162, 205) 100%)",
        filter: "drop-shadow(rgb(227, 94, 73) 0px 0px 0.1px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(252, 232, 215) 0%, rgb(255, 232, 215) 25%, rgb(240, 83, 70) 25%, rgb(240, 83, 70) 50%, rgb(244, 173, 23) 50%, rgb(244, 173, 23) 75%, rgb(41, 162, 205) 75%, rgb(41, 162, 205) 100%); filter: drop-shadow(rgb(227, 94, 73) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Wintergreen oA",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(255, 255, 255) 0%, rgb(120, 247, 192) 20%, rgb(5, 77, 41) 51%, rgb(0, 112, 64) 70%)",
        filter: "drop-shadow(rgb(0, 61, 15) 0px 0px 4px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(255, 255, 255) 0%, rgb(120, 247, 192) 20%, rgb(5, 77, 41) 51%, rgb(0, 112, 64) 70%); filter: drop-shadow(rgb(0, 61, 15) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "O' November oA",
        category: "paint",
        type: "gradient",
        value: "repeating-radial-gradient(circle, rgb(213, 93, 93) 20%, rgb(129, 54, 14) 35%, rgb(255, 184, 102) 55%, rgb(99, 96, 64) 75%)",
        filter: "drop-shadow(rgb(160, 50, 13) 0px 0px 4px)",
        previewStyle: "background-image: repeating-radial-gradient(circle, rgb(213, 93, 93) 20%, rgb(129, 54, 14) 35%, rgb(255, 184, 102) 55%, rgb(99, 96, 64) 75%); filter: drop-shadow(rgb(160, 50, 13) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Wicked Witch",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(63, 48, 64) 0%, rgb(101, 61, 102) 25%, rgb(255, 0, 225) 50%, rgb(255, 221, 0) 75%, rgb(255, 85, 0) 100%)",
        filter: "drop-shadow(rgb(241, 97, 23) 0px 0px 0.1px) drop-shadow(rgb(20, 0, 19) 1px 1px 0.1px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(63, 48, 64) 0%, rgb(101, 61, 102) 25%, rgb(255, 0, 225) 50%, rgb(255, 221, 0) 75%, rgb(255, 85, 0) 100%); filter: drop-shadow(rgb(241, 97, 23) 0px 0px 0.1px) drop-shadow(rgb(20, 0, 19) 1px 1px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Ghastly",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(64, 108, 196) 15%, rgb(34, 94, 191) 35%, rgb(255, 255, 255) 60%)",
        filter: "drop-shadow(rgb(154, 211, 254) 0px 1px 0.1px) drop-shadow(rgb(0, 110, 255) 0px 0px 3px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(64, 108, 196) 15%, rgb(34, 94, 191) 35%, rgb(255, 255, 255) 60%); filter: drop-shadow(rgb(154, 211, 254) 0px 1px 0.1px) drop-shadow(rgb(0, 110, 255) 0px 0px 3px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Vitality",
        category: "paint",
        type: "gradient",
        value: "repeating-linear-gradient(198deg, rgb(186, 186, 186) 0%, rgb(135, 135, 135) 10%, rgb(174, 255, 0) 20%, rgb(0, 255, 238) 33%)",
        filter: "drop-shadow(rgb(128, 255, 0) 0px 1px 0.1px)",
        previewStyle: "background-image: repeating-linear-gradient(198deg, rgb(186, 186, 186) 0%, rgb(135, 135, 135) 10%, rgb(174, 255, 0) 20%, rgb(0, 255, 238) 33%); filter: drop-shadow(rgb(128, 255, 0) 0px 1px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Moldy Cheese",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(24, 114, 91) 0%, rgb(68, 227, 166) 20%, rgb(222, 237, 14) 40%, rgb(220, 250, 249) 60%, rgb(49, 112, 91) 80%, rgb(49, 112, 91) 100%)",
        filter: "drop-shadow(rgb(62, 110, 91) 0px 0px 0.1px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(24, 114, 91) 0%, rgb(68, 227, 166) 20%, rgb(222, 237, 14) 40%, rgb(220, 250, 249) 60%, rgb(49, 112, 91) 80%, rgb(49, 112, 91) 100%); filter: drop-shadow(rgb(62, 110, 91) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Octopus",
        category: "paint",
        type: "gradient",
        value: "repeating-radial-gradient(circle, rgb(65, 222, 238) 0%, rgb(65, 222, 238) 20%, rgb(246, 238, 0) 20%, rgb(246, 238, 0) 40%, rgb(148, 148, 148) 40%, rgb(148, 148, 148) 60%)",
        filter: "drop-shadow(rgb(117, 117, 117) 0px 0px 0.1px)",
        previewStyle: "background-image: repeating-radial-gradient(circle, rgb(65, 222, 238) 0%, rgb(65, 222, 238) 20%, rgb(246, 238, 0) 20%, rgb(246, 238, 0) 40%, rgb(148, 148, 148) 40%, rgb(148, 148, 148) 60%); filter: drop-shadow(rgb(117, 117, 117) 0px 0px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Neon Nights",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(circle, rgb(57, 254, 221) 0%, rgb(46, 255, 220) 25%, rgb(92, 211, 255) 25%, rgb(148, 103, 254) 50%, rgb(130, 77, 254) 50%, rgb(227, 46, 255) 75%, rgb(224, 0, 213) 75%, rgb(184, 0, 174) 100%)",
        filter: "drop-shadow(rgb(0, 112, 168) 0px 0px 0.1px) drop-shadow(rgb(85, 0, 189) 0px 0px 4px)",
        previewStyle: "background-image: radial-gradient(circle, rgb(57, 254, 221) 0%, rgb(46, 255, 220) 25%, rgb(92, 211, 255) 25%, rgb(148, 103, 254) 50%, rgb(130, 77, 254) 50%, rgb(227, 46, 255) 75%, rgb(224, 0, 213) 75%, rgb(184, 0, 174) 100%); filter: drop-shadow(rgb(0, 112, 168) 0px 0px 0.1px) drop-shadow(rgb(85, 0, 189) 0px 0px 4px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Devotion",
        category: "paint",
        type: "gradient",
        value: "radial-gradient(rgb(255, 255, 255) 0%, rgb(255, 246, 189) 15%, rgb(253, 255, 148) 35%, rgb(229, 36, 255) 84%)",
        filter: "drop-shadow(rgb(255, 0, 208) 0px 1px 0.1px)",
        previewStyle: "background-image: radial-gradient(rgb(255, 255, 255) 0%, rgb(255, 246, 189) 15%, rgb(253, 255, 148) 35%, rgb(229, 36, 255) 84%); filter: drop-shadow(rgb(255, 0, 208) 0px 1px 0.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Tropica oA",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(rgb(255, 15, 179) 30%, rgb(255, 213, 0) 60%, rgb(102, 224, 255) 70%)",
        filter: "drop-shadow(rgb(255, 0, 123) 0px 0px 5.1px)",
        previewStyle: "background-image: linear-gradient(rgb(255, 15, 179) 30%, rgb(255, 213, 0) 60%, rgb(102, 224, 255) 70%); filter: drop-shadow(rgb(255, 0, 123) 0px 0px 5.1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "ftk789",
        category: "paint",
        type: "gradient",
        value: "url('https://cdn.7tv.app/paint/01JM8F9NQPFQEF9GQMT5RB9BAG/layer/01JM8G5NZJN36FF9137NCVGV2R/1x.webp')",
        filter: "drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(141, 0, 255) 0px 0px 3px)",
        previewStyle: "background-image: url('https://cdn.7tv.app/paint/01JM8F9NQPFQEF9GQMT5RB9BAG/layer/01JM8G5NZJN36FF9137NCVGV2R/1x.webp'); filter: drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(255, 0, 0) 0px 0px 0.5px) drop-shadow(rgb(141, 0, 255) 0px 0px 3px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Infernal oA",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(rgb(255, 221, 0) 0%, rgb(255, 228, 92) 10%, rgb(208, 202, 37) 15%, rgb(196, 161, 33) 25%, rgb(102, 85, 0) 35%, rgb(0, 0, 0) 65%)",
        filter: "drop-shadow(rgb(255, 200, 0) -1px 0px 1px) drop-shadow(rgb(255, 174, 0) 1px 0px 0.1px) drop-shadow(rgb(255, 0, 0) 0px -2px 2px)",
        previewStyle: "background-image: linear-gradient(rgb(255, 221, 0) 0%, rgb(255, 228, 92) 10%, rgb(208, 202, 37) 15%, rgb(196, 161, 33) 25%, rgb(102, 85, 0) 35%, rgb(0, 0, 0) 65%); filter: drop-shadow(rgb(255, 200, 0) -1px 0px 1px) drop-shadow(rgb(255, 174, 0) 1px 0px 0.1px) drop-shadow(rgb(255, 0, 0) 0px -2px 2px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    },
    {
        name: "Clownfish",
        category: "paint",
        type: "gradient",
        value: "linear-gradient(135deg, rgb(229, 240, 255) 35%, rgb(255, 102, 0) 55%)",
        filter: "drop-shadow(rgb(237, 118, 38) 0px 0px 1px)",
        previewStyle: "background-image: linear-gradient(135deg, rgb(229, 240, 255) 35%, rgb(255, 102, 0) 55%); filter: drop-shadow(rgb(237, 118, 38) 0px 0px 1px); -webkit-background-clip: text; color: transparent; font-weight: 900;",
        price: 100
    }
];

// BATTLEPASS CONFIG
const BP_LEVELS = [
    { lvl: 1, free: {type:'coin', val:50, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'coin', val:100, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'} },
    { lvl: 2, free: {type:'coin', val:50, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'paint', val:'Summer', img:'https://cdn-icons-png.flaticon.com/512/3953/3953423.png'} },
    { lvl: 3, free: {type:'badge', val:'Classic', img:'https://i.postimg.cc/0y9k3HQD/1.png'}, prem: {type:'coin', val:200, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'} },
    { lvl: 4, free: {type:'coin', val:75, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'paint', val:'Sunset', img:'https://cdn-icons-png.flaticon.com/512/3953/3953423.png'} },
    { lvl: 5, free: {type:'coin', val:100, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'badge', val:'King Crown', img:'https://cdn-icons-png.flaticon.com/512/2545/2545603.png'} },
    { lvl: 6, free: {type:'coin', val:100, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'coin', val:300, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'} },
    { lvl: 7, free: {type:'coin', val:100, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'paint', val:'Infernal oA', img:'https://cdn-icons-png.flaticon.com/512/3953/3953423.png'} },
    { lvl: 8, free: {type:'coin', val:150, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'coin', val:500, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'} },
    { lvl: 9, free: {type:'badge', val:'Classic', img:'https://i.postimg.cc/0y9k3HQD/1.png'}, prem: {type:'paint', val:'Tropica oA', img:'https://cdn-icons-png.flaticon.com/512/3953/3953423.png'} },
    { lvl: 10, free: {type:'coin', val:500, img:'https://cdn-icons-png.flaticon.com/512/1490/1490860.png'}, prem: {type:'paint', val:'Swag ponad Swag bratku', img:'https://cdn-icons-png.flaticon.com/512/616/616430.png'} },
];

// INIT
window.onload = async () => {
    try {
        const kn = localStorage.getItem('gato_kick_nick'); if(kn) AppState.kickNick = kn;
        const favs = localStorage.getItem('gato_favorites'); if(favs) AppState.favorites = JSON.parse(favs);
        const stv = localStorage.getItem('gato_7tv_panel_id'); if(stv) AppState.sevenTvId = stv;
    } catch(e) {}
    
    updateCoinDisplay(); 

    if (location.hash.includes('access_token')) {
        const t = new URLSearchParams(location.hash.substring(1)).get('access_token');
        if(t) { localStorage.setItem('tw_token', t); history.replaceState({},document.title,location.pathname); await verifyToken(t); return; }
    }
    const t = localStorage.getItem('tw_token');
    if(t) await verifyToken(t); else showLoginScreen();
};

function loginWithTwitch() { location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=user:read:email`; }

function loginAsGuest() {
    const guestUser = {
        id: "guest_123",
        login: "guest_user",
        display_name: "Guest User",
        profile_image_url: "https://cdn-icons-png.flaticon.com/512/149/149071.png"
    };
    AppState.user = guestUser;
    AppState.token = "guest_token";
    showDashboard(guestUser);
    fetchCloudData();
}

async function verifyToken(t) {
    try {
        const r = await fetch('https://api.twitch.tv/helix/users', { headers: {'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${t}`} });
        const d = await r.json();
        if(d.data && d.data[0]) {
            AppState.user = d.data[0]; AppState.token = t; showDashboard(AppState.user); fetchCloudData();
        } else throw 1;
    } catch(e) { localStorage.removeItem('tw_token'); showLoginScreen(); }
}

function logout() { localStorage.removeItem('tw_token'); location.reload(); }

// UI
function showLoginScreen() {
    document.getElementById('loginBtnContainer').style.display='block';
    document.getElementById('userProfileFloater').style.display='none';
    document.getElementById('coinDisplay').style.display='none';
    document.getElementById('searchContainer').style.display='none';
    document.getElementById('redeemBtn').style.display='none';
    document.getElementById('bottomLeftControls').style.display='none';
    document.querySelectorAll('.login-blocker').forEach(e=>e.style.display='flex');
    document.querySelectorAll('.protected-content').forEach(e=>e.style.display='none');
    document.getElementById('userRoleBadge').style.display='none';
    document.getElementById('btnConnections').style.display='none';
    document.body.style.overflow = 'hidden';
}

function showDashboard(u) {
    document.getElementById('loginBtnContainer').style.display='none';
    document.getElementById('userProfileFloater').style.display='flex';
    document.getElementById('coinDisplay').style.display='flex';
    document.getElementById('searchContainer').style.display='block';
    document.getElementById('redeemBtn').style.display='flex';
    document.querySelectorAll('.login-blocker').forEach(e=>e.setAttribute('style','display:none !important'));
    document.querySelectorAll('.protected-content').forEach(e=>e.setAttribute('style','display:block !important'));
    document.body.style.overflow = '';

    document.getElementById('floaterAvatar').src = u.profile_image_url;
    document.getElementById('floaterName').innerText = u.display_name;
    document.getElementById('profileAvatarBig').src = u.profile_image_url;
    document.getElementById('profileNameBig').innerText = u.display_name;
    
    document.querySelectorAll('.preview-user').forEach(el => el.innerText = u.display_name);
    
    if(AppState.kickNick) document.getElementById('kickNickInputModal').value = AppState.kickNick;

    // ROLE FETCHED LATER IN CLOUD DATA
    
    const group = document.getElementById('bottomLeftControls');
    group.style.display = 'flex';
    
    document.getElementById('btnConnections').style.display = 'flex';
    document.getElementById('collectionStats').style.display = 'flex';
    
    // Pokaż podgląd jeśli jesteśmy na profilu (domyślny stan)
    if(document.getElementById('profile').classList.contains('active')) document.getElementById('previewContainer').style.display = 'flex';
}

function setProfileData(name, avatar, role) {
    document.getElementById('profileAvatarBig').src = avatar;
    document.getElementById('profileNameBig').innerText = name;
    document.getElementById('profileRoleTag').innerText = role;
}

// CONNECTIONS & KICK INTEGRATION
window.openConnectionsModal = function() {
    document.getElementById('modalConnections').style.display = 'flex';
    if(AppState.kickNick) document.getElementById('kickNickInputModal').value = AppState.kickNick;
}
window.closeConnectionsModal = function() {
    document.getElementById('modalConnections').style.display = 'none';
}

window.saveKickNick = async function() {
    const val = document.getElementById('kickNickInputModal').value.trim().toLowerCase();
    if(!val) { alert("Wpisz nick!"); return; }
    
    AppState.kickNick = val;
    localStorage.setItem('gato_kick_nick', val);
    
    if(AppState.loadout && Object.keys(AppState.loadout).length > 0) {
        await api(`premium/${val}`, "PUT", AppState.loadout);
        alert(`Nick Kick zapisany: ${val}.\nTwój ekwipunek został skopiowany!`);
    } else {
        alert(`Nick Kick zapisany: ${val}`);
    }
    closeConnectionsModal();
}

window.deleteKickNick = async function() {
    if(!AppState.kickNick) return;
    if(confirm(`Czy na pewno usunąć powiązanie z Kick nickiem: ${AppState.kickNick} z API?`)) {
        await api(`premium/${AppState.kickNick}`, "DELETE");
        localStorage.removeItem('gato_kick_nick');
        AppState.kickNick = null;
        document.getElementById('kickNickInputModal').value = "";
        alert("Usunięto powiązanie.");
        closeConnectionsModal();
    }
}

// SEARCH
document.getElementById('userSearchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchUserProfile(e.target.value); });
async function searchUserProfile(username) {
    if(!username) return;
    switchTab('profile');
    try {
        const r = await fetch(`https://api.twitch.tv/helix/users?login=${username.toLowerCase()}`, { headers: {'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${AppState.token}`} });
        const d = await r.json();
        if(d.data && d.data[0]) {
            const t = d.data[0];
            AppState.viewingUser = t;
            setProfileData(t.display_name, t.profile_image_url, "VIEWING");
            document.getElementById('viewingBadge').style.display='inline-block';
            document.getElementById('btnBackToMe').style.display='block';
            document.getElementById('bottomLeftControls').style.display='none'; // Hide own controls when viewing
            document.getElementById('collectionStats').style.display='none'; // Hide stats when viewing others
            await fetchProfileDataFor(t.login.toLowerCase());
        } else alert("Nie znaleziono");
    } catch(e) { console.log(e); }
}

async function fetchProfileDataFor(u) {
    const res = await fetch(`${DB_URL}/premium/${u}.json`);
    const loadout = res.ok ? (await res.json() || {}) : {};
    const fakeInv = [];
    if(loadout.paint) fakeInv.push({name:"Active Paint", category:"paint", value:loadout.paint.value, previewStyle:""});
    if(loadout.badge) fakeInv.push({name:"Active Badge", category:"badge", value:loadout.badge, previewStyle:""});
    renderProfileInventory(fakeInv);
    renderProfileEmotes('uploaded', u);
    renderProfileEmotes('channel', u);
}

function returnToMyProfile() {
    AppState.viewingUser = null;
    document.getElementById('viewingBadge').style.display='none';
    document.getElementById('btnBackToMe').style.display='none';
    document.getElementById('bottomLeftControls').style.display='flex'; // Show back
    document.getElementById('collectionStats').style.display='flex'; 
    if(AppState.user) setProfileData(AppState.user.display_name, AppState.user.profile_image_url, AppState.role);
    renderProfileInventory(); renderProfileEmotes('uploaded'); renderProfileEmotes('channel');
}

// TABS
window.switchTab = function(id) {
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Only highlight nav if it's one of the main tabs (not admin)
    const navBtn = document.querySelector(`nav button[onclick="switchTab('${id}')"]`);
    if(navBtn) navBtn.classList.add('active');
    
    // Zarządzanie widocznością podglądu (tylko w zakładce profile)
    const preview = document.getElementById('previewContainer');
    if(preview) preview.style.display = (id === 'profile') ? 'flex' : 'none';

    // HIDE FLOATING UI ON DOWNLOAD TAB
    if (AppState.user) {
        const isDownload = (id === 'download');
        const displayFlex = isDownload ? 'none' : 'flex';
        const displayBlock = isDownload ? 'none' : 'block';

        document.getElementById('userProfileFloater').style.display = displayFlex;
        document.getElementById('redeemBtn').style.display = displayFlex;
        document.getElementById('bottomLeftControls').style.display = displayFlex;
        document.getElementById('coinDisplay').style.display = displayFlex;
        document.getElementById('searchContainer').style.display = displayBlock;
    }
}
window.switchProfileSubTab = function(tab) {
    document.getElementById('profileInventory').style.display = tab==='inventory'?'block':'none';
    document.getElementById('profileChannel').style.display = tab==='channel'?'block':'none';
    
    document.getElementById('pTabInv').className = tab==='inventory'?'active':'';
    document.getElementById('pTabCh').className = tab==='channel'?'active':'';
    
    const target = AppState.viewingUser ? AppState.viewingUser.login.toLowerCase() : (AppState.user ? AppState.user.login.toLowerCase() : null);
    if(target) {
        if(tab === 'inventory') { if(AppState.viewingUser) fetchProfileDataFor(target); else renderProfileInventory(); }
        if(tab === 'channel') switchEmoteMenuTab(1);
    }
}

// INVENTORY HELPERS
window.setInvFilter = function(f) {
    AppState.invFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`fBtn_${f}`).classList.add('active');
    renderProfileInventory();
}

window.toggleFavorite = function(name) {
    const idx = AppState.favorites.indexOf(name);
    if(idx === -1) AppState.favorites.push(name);
    else AppState.favorites.splice(idx, 1);
    
    localStorage.setItem('gato_favorites', JSON.stringify(AppState.favorites));
    renderProfileInventory();
}

window.switchEmoteMenuTab = function(idx) {
    document.querySelectorAll('#profileChannel .emote-sub-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(`pemBtn${idx}`).classList.add('active');
    
    document.getElementById('pemContent1').style.display = idx===1 ? 'block' : 'none';
    document.getElementById('pemContent2').style.display = idx===2 ? 'block' : 'none';
    document.getElementById('pemContent3').style.display = idx===3 ? 'block' : 'none';
    document.getElementById('pemContent4').style.display = idx===4 ? 'block' : 'none';
    
    const target = AppState.viewingUser ? AppState.viewingUser.login.toLowerCase() : (AppState.user ? AppState.user.login.toLowerCase() : null);
    if(target) {
        if(idx===1) renderProfileEmotes('channel', target);
        if(idx===2) renderPersonalEmotes(target);
        if(idx===3) renderProfileEmotes('uploaded', target);
        if(idx===4) {
            if(AppState.sevenTvId) {
                update7tvUI(true, AppState.sevenTvId);
                if(document.getElementById('panel7tvGrid').innerHTML === '') load7tvInPanel(AppState.sevenTvId);
            } else {
                update7tvUI(false);
            }
        }
    }
}

window.load7tvInPanel = async function(manualId = null) {
    const id = manualId || document.getElementById('input7tvPanel').value.trim();
    if(!id) return;
    const grid = document.getElementById('panel7tvGrid');
    grid.innerHTML = 'Ładowanie...';
    try {
        const r = await fetch(`https://7tv.io/v3/emote-sets/${id}`);
        if(!r.ok) throw 1;
        const d = await r.json();
        
        AppState.sevenTvId = id;
        localStorage.setItem('gato_7tv_panel_id', id);
        update7tvUI(true, id);
        
        // SYNC WITH API (So plugin can see it)
        if(AppState.user) await api(`premium/${AppState.user.login.toLowerCase()}/sevenTvId`, "PUT", id);
        
        grid.innerHTML = '';
        if(d.emotes.length === 0) { grid.innerHTML = 'Pusty zestaw.'; return; }
        
        d.emotes.forEach(e => {
            const url = `https:${e.data.host.url}/2x.webp`;
            const div = document.createElement('div');
            div.className = 'emote-card';
            div.innerHTML = `<img src="${url}"><div class="name">${e.name}</div>`;
            div.onclick = () => { navigator.clipboard.writeText(url); alert("Skopiowano URL: " + url); };
            grid.appendChild(div);
        });
    } catch(e) { grid.innerHTML = 'Błąd ładowania (złe ID?).'; update7tvUI(false); }
}

window.disconnect7tv = async function() {
    AppState.sevenTvId = null;
    localStorage.removeItem('gato_7tv_panel_id');
    document.getElementById('panel7tvGrid').innerHTML = '';
    document.getElementById('input7tvPanel').value = '';
    update7tvUI(false);
    
    // SYNC WITH API
    if(AppState.user) await api(`premium/${AppState.user.login.toLowerCase()}/sevenTvId`, "DELETE");
}

function update7tvUI(isLoaded, id) {
    const inputArea = document.getElementById('input7tvArea');
    const statusArea = document.getElementById('status7tvArea');
    if(isLoaded) {
        inputArea.style.display = 'none';
        statusArea.style.display = 'flex';
        document.getElementById('status7tvText').innerText = `SET ZAŁADOWANY (ID: ${id})`;
    } else {
        inputArea.style.display = 'flex';
        statusArea.style.display = 'none';
    }
}

// RENDERING
function renderProfileInventory(overrideItems = null) {
    const grid = document.getElementById('profileInvGrid');
    if(!grid) return; grid.innerHTML = "";
    
    let items = [], mode = 'inventory';
    if(AppState.viewingUser || overrideItems) { mode='profile'; items=overrideItems||[]; }
    else items = CATALOG.filter(i => AppState.owned.includes(i.name));
    
    // FILTERING & SORTING (Only for own inventory)
    if(mode === 'inventory') {
        const search = document.getElementById('invSearch') ? document.getElementById('invSearch').value.toLowerCase() : '';
        
        // Filter by Category/Fav
        if(AppState.invFilter === 'fav') items = items.filter(i => AppState.favorites.includes(i.name));
        else if(AppState.invFilter !== 'all') items = items.filter(i => i.category === AppState.invFilter);
        
        // Filter by Search
        if(search) items = items.filter(i => i.name.toLowerCase().includes(search));
    }
    
    if(items.length===0) grid.innerHTML='<div class="empty-state-styled"><i class="fas fa-box-open"></i><span>Twój ekwipunek jest pusty</span></div>';
    else items.forEach(i => grid.appendChild(createCard(i, mode)));
}

function renderProfileEmotes(type, target) {
    const grid = document.getElementById(type==='uploaded' ? 'myUploadedGrid' : 'profileChannelGrid');
    if(!grid) return;
    const login = target || (AppState.user ? AppState.user.login : '');
    const author = AppState.viewingUser ? AppState.viewingUser.display_name : (AppState.user ? AppState.user.display_name : '');
    const all = AppState.emotes;
    let keys = [];
    if(type==='uploaded') keys = Object.keys(all).filter(k => all[k].author === author);
    else keys = Object.keys(all).filter(k => {
        // FIX: Sprawdzamy czy kanał zawiera login (obsługa wielu nicków po przecinku)
        const channelList = (all[k].channel || "").toLowerCase();
        return channelList.includes(login.toLowerCase()) && all[k].status !== 'pending';
    });
    
    if(keys.length===0 && type !== 'uploaded') { grid.innerHTML='<div class="empty-state-styled" style="padding:20px;"><i class="fas fa-ghost"></i><span>Brak emotek</span></div>'; return; }
    
    if(type === 'uploaded') {
         return keys; 
    } else {
         grid.innerHTML = keys.map(k => {
             let action = '';
             if(login === AppState.user.login) {
                 action = `
                    <div class="action-overlay del-btn" style="background:#ef4444;" onclick="event.stopPropagation(); if(confirm('Odpiąć/Usunąć?')) delEmote('${k}')">✖</div>
                    <div class="action-overlay edit-btn" onclick="event.stopPropagation(); renameEmote('${k}')"><i class="fas fa-pen"></i></div>
                 `;
             }
             return `<div class="emote-card" onclick="openEmoteDetail('${k}')">${action}<img src="${all[k].url}"><div class="name">${k}</div></div>`;
         }).join('');
    }
}

function renderPersonalEmotes(target) {
    const grid = document.getElementById('personalEmotesGrid');
    if(!grid) return; grid.innerHTML = '';
    
    const list = (target === AppState.user?.login.toLowerCase()) ? AppState.personalEmotes : []; 
    
    for(let i=0; i<5; i++) {
        const key = list[i];
        const div = document.createElement('div');
        if(key && AppState.emotes[key]) {
            div.className = 'slot-box filled';
            div.innerHTML = `<img src="${AppState.emotes[key].url}" class="slot-content-img"><div class="slot-del-overlay" onclick="removeFromPersonal('${key}')">USUŃ</div>`;
        } else {
            div.className = 'slot-box';
            div.innerHTML = `<i class="fas fa-plus slot-empty-icon" style="font-size:16px;"></i>`;
            div.onclick = () => { switchTab('emotes'); alert("Wybierz emotkę z galerii i kliknij 'Dodaj do Personalnych'"); };
        }
        grid.appendChild(div);
    }
}

function renderShop() {
    const div = document.getElementById('shopContent');
    if(!div) return; div.innerHTML='';
    let hasItems = false;
    
    // NEW LOGIC: Use AppState.shopActive from API (Object: Name -> Price)
    const activeShopData = AppState.shopActive || {};
    const activeNames = Object.keys(activeShopData);

    ['paint', 'badge'].forEach(cat => {
        // Filter: Must be in CATALOG AND must be in Active API list AND not owned
        // REMOVED LIMIT: Shows all active items
        let items = CATALOG.filter(i => 
            i.category === cat && 
            activeNames.includes(i.name) && 
            !AppState.owned.includes(i.name)
        );
        
        if(items.length > 0) {
            hasItems = true;
            const title = document.createElement('div'); title.className='shop-section-title'; title.innerText=cat.toUpperCase(); div.appendChild(title);
            const grid = document.createElement('div'); grid.className='preset-grid'; 
            
            items.forEach(i => {
                // OVERRIDE PRICE FROM API
                const apiPrice = activeShopData[i.name];
                // Create a copy of item with new price for display
                const itemWithApiPrice = { ...i, price: apiPrice };
                grid.appendChild(createCard(itemWithApiPrice, 'shop'));
            });
            
            div.appendChild(grid);
        }
    });
    
    if(!hasItems) {
        div.innerHTML = '<div class="empty-state-styled" style="padding: 60px;"><i class="fas fa-store-slash" style="font-size:48px; color:#ef4444;"></i><span style="font-size:18px; margin-top:10px; color:#fff;">SKLEP WYPRZEDANY</span><span style="font-weight:400; font-size:12px;">Wykupiłeś wszystko z obecnej oferty!</span></div>';
    }
}

function createCard(item, mode) {
    const isShop = (mode === 'shop');
    const className = isShop ? "preset-card" : "inventory-card owned";
    
    const d = document.createElement("div"); 
    d.className = className;
    
    d.onmouseenter = () => updatePreviewUI(item);
    d.onmouseleave = () => updatePreview(AppState.loadout);
    
    // Add Fav Button if in inventory mode
    let favHtml = '';
    if(mode === 'inventory') {
        const isFav = AppState.favorites.includes(item.name);
        favHtml = `<i class="fas fa-heart fav-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${item.name}')"></i>`;
    }
    
    let btn = "";
    if(isShop) btn = `<button class="btn-action btn-buy" onclick="doBuy('${item.name}')">KUP ${item.price}</button>`;
    else if(mode==='inventory') {
        let isEquipped = false;
        const current = AppState.loadout[item.category];
        if(current) {
             if(typeof current === 'object' && current.value === item.value) isEquipped = true;
             else if(current === item.value) isEquipped = true;
        }

        btn = isEquipped ? 
              `<button class="btn-action btn-unequip" onclick="doUnequip('${item.category}')">ZDEJMIJ</button>` : 
              `<button class="btn-action btn-equip" onclick="doEquip('${item.name}')">ZAŁÓŻ</button>`;
    } else btn = `<span style="font-size:10px; color:#aaa">POSIADASZ</span>`;
    
    let view = item.category === 'badge' ? `<img src="${item.value}" class="gato-badge-preview">` : `<div style="${item.previewStyle}">Aa</div>`;
    
    d.innerHTML = `${favHtml}<span class="category-badge cat-${item.category}">${item.category}</span><div class="card-preview">${view}</div><div class="card-info"><div class="preset-name">${item.name}</div>${btn}</div>`;
    return d;
}

window.doBuy = async function(name) {
    if(!AppState.user) return;
    
    // SECURITY: Get price from API state, NOT from local catalog
    const apiPrice = AppState.shopActive[name];
    
    if(apiPrice === undefined) {
        alert("Błąd: Tego przedmiotu nie ma w aktywnym sklepie (API).");
        return;
    }
    
    if(AppState.coins >= apiPrice) {
        AppState.coins -= apiPrice; 
        AppState.owned.push(name);
        
        updateCoinDisplay(); 
        renderShop(); 
        renderProfileInventory(); 
        fireConfetti(true);
        
        await saveUserData();
    } else alert("Brak monet");
}

window.doEquip = async function(name) {
    const item = CATALOG.find(i=>i.name===name);
    let pl = item.value;
    if(item.category==='paint') { pl = {type:item.type, value:item.value}; if(item.shadow) pl.shadow=item.shadow; if(item.filter) pl.filter=item.filter; }
    
    AppState.loadout[item.category] = (item.category==='paint') ? pl : item.value;
    
    renderProfileInventory();
    updatePreview(AppState.loadout);
    
    await api(`premium/${AppState.user.login.toLowerCase()}/${item.category}`, "PUT", pl);
    
    if(AppState.kickNick) {
        await api(`premium/${AppState.kickNick}/${item.category}`, "PUT", pl);
    }
}

window.doUnequip = async function(cat) {
    delete AppState.loadout[cat]; 
    renderProfileInventory(); 
    updatePreview(AppState.loadout);
    
    await api(`premium/${AppState.user.login.toLowerCase()}/${cat}`, "DELETE");
    if(AppState.kickNick) {
        await api(`premium/${AppState.kickNick}/${cat}`, "DELETE");
    }
}

function updatePreview(d) {
    const users = document.querySelectorAll('.preview-user');
    const badges = document.querySelectorAll('.preview-badges');

    users.forEach(u => { 
        u.style=""; 
        u.className="chat-username preview-user"; 
    });
    badges.forEach(b => b.innerHTML="");

    if(!d) return;

    if(d.paint) {
        users.forEach(u => {
            // FIX: Obsługa filtra (drop-shadow) jeśli istnieje
            if(d.paint.filter) {
                u.style.filter = d.paint.filter;
            }
            
            if(d.paint.type==='gradient') { 
                u.style.backgroundImage = d.paint.value; 
                u.style.webkitBackgroundClip = 'text'; 
                u.style.color = 'transparent'; 
                u.style.fontWeight = '900'; 
                // Animacja
                u.style.backgroundSize = '200% auto';
                u.style.animation = 'gatoShine 3s linear infinite';
            } else { 
                u.style.color = d.paint.value; 
                // Jeśli to zwykły kolor, ale ma cień (np. neon blue)
                if(d.paint.shadow) {
                    u.style.textShadow = `0 0 5px ${d.paint.shadow}`;
                }
            }
        });
    }
    if(d.badge) {
        badges.forEach(b => {
            b.innerHTML=`<img src="${d.badge}" class="gato-badge-preview">`;
        });
    }
}

function updatePreviewUI(item) {
    const users = document.querySelectorAll('.preview-user');
    const badges = document.querySelectorAll('.preview-badges');

    if(item.category==='paint') {
        users.forEach(u => {
             u.style.cssText = item.previewStyle;
             if(item.filter) u.style.filter = item.filter;
        });
    }
    if(item.category==='badge') {
        badges.forEach(b => b.innerHTML = `<img src="${item.value}" class="gato-badge-preview">`);
    }
}

// EMOTES
window.setEmoteTab = function(t) { 
    AppState.emoteTab=t; 
    AppState.emotePage = 1;
    
    document.getElementById('tabGlobal').classList.toggle('active', t === 'global');
    document.getElementById('tabUsers').classList.toggle('active', t === 'users');
    
    const subMenu = document.getElementById('usersSubMenu');
    if(subMenu) subMenu.style.display = (t === 'users') ? 'flex' : 'none';
    
    renderEmotes(); 
}
window.setEmoteSort = function(s) { 
    AppState.emoteSort=s; 
    document.getElementById('sortNew').classList.toggle('active', s === 'new');
    document.getElementById('sortTrending').classList.toggle('active', s === 'trending');
    document.getElementById('sortTop').classList.toggle('active', s === 'top');
    AppState.emotePage = 1;
    renderEmotes(); 
}
async function loadAllEmotes() { AppState.emotes = await api('emotes') || {}; renderEmotes(); }
function renderEmotes() {
    const grid = document.getElementById('emotesGrid');
    const pagination = document.getElementById('emotesPagination');
    const all = AppState.emotes;
    const searchText = document.getElementById('emoteSidebarSearch') ? document.getElementById('emoteSidebarSearch').value.toLowerCase() : '';
    
    // Filter logic: Exclude pending for everyone in the public gallery
    let keys = Object.keys(all).filter(k => {
        const e = all[k];
        // Only show APPROVED emotes in gallery (unless status is undefined which means old approved)
        if(e.status === 'pending') return false; 
        
        const matchesTab = AppState.emoteTab === 'global' ? e.scope === 'global' : e.scope !== 'global';
        const matchesSearch = !searchText || k.toLowerCase().includes(searchText);
        return matchesTab && matchesSearch;
    });

    // PAGINATION LOGIC
    const ITEMS_PER_PAGE = 60; // ~5 rzędów
    const totalPages = Math.ceil(keys.length / ITEMS_PER_PAGE);
    
    if (AppState.emotePage > totalPages) AppState.emotePage = 1;
    if (AppState.emotePage < 1) AppState.emotePage = 1;
    
    const start = (AppState.emotePage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageKeys = keys.slice(start, end);

    // RENDER GRID
    if(pageKeys.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#64748b;">Brak emotek spełniających kryteria.</div>';
    } else {
        grid.innerHTML = pageKeys.map(k => {
        // ADMIN DELETE BUTTON in Gallery
        let adminAction = '';
        if(AppState.role === 'ADMIN') {
             adminAction = `<div class="action-overlay del-btn" style="background:#ef4444;" onclick="event.stopPropagation(); if(confirm('ADMIN: Usunąć emotkę ${k}?')) delEmote('${k}')">✖</div>`;
        }
        
        return `<div class="emote-card" onclick="openEmoteDetail('${k}')">
            ${adminAction}
            <img src="${all[k].url}">
            <div class="name">${k}</div>
        </div>`;
    }).join('');
    }

    // RENDER PAGINATION CONTROLS
    pagination.innerHTML = '';
    if (totalPages > 1) {
        // Prev Button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.disabled = AppState.emotePage === 1;
        prevBtn.onclick = () => { AppState.emotePage--; renderEmotes(); document.getElementById('emotesGalleryView').scrollIntoView({behavior:'smooth'}); };
        pagination.appendChild(prevBtn);

        // Page Info
        const info = document.createElement('div');
        info.className = 'page-btn';
        info.style.cursor = 'default';
        info.style.border = 'none';
        info.style.background = 'transparent';
        info.innerText = `${AppState.emotePage} / ${totalPages}`;
        pagination.appendChild(info);

        // Next Button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = AppState.emotePage === totalPages;
        nextBtn.onclick = () => { AppState.emotePage++; renderEmotes(); document.getElementById('emotesGalleryView').scrollIntoView({behavior:'smooth'}); };
        pagination.appendChild(nextBtn);
    }
}

// MODAL
window.openEmoteDetail = async function(k) {
    const e = AppState.emotes[k]; AppState.currentEmoteKey=k; AppState.currentEmoteData=e;
    document.getElementById('mImg').src=e.url; document.getElementById('mCode').innerText=k; document.getElementById('mAuth').innerText=e.author;
    
    // Reset votes UI
    document.getElementById('btnVoteUp').className = 'vote-btn';
    document.getElementById('btnVoteDown').className = 'vote-btn';
    document.getElementById('voteCountUp').innerText = "0";
    document.getElementById('voteCountDown').innerText = "0";
    
    // Fetch Votes
    try {
        const votes = await api(`emotes/${k}/votes`) || {};
        AppState.currentEmoteVotes = votes;
        
        let up = 0, down = 0;
        let myVote = 0;
        
        Object.keys(votes).forEach(user => {
            if(votes[user] === 1) up++;
            if(votes[user] === -1) down++;
            if(user === AppState.user.login) myVote = votes[user];
        });
        
        document.getElementById('voteCountUp').innerText = up;
        document.getElementById('voteCountDown').innerText = down;
        
        if(myVote === 1) document.getElementById('btnVoteUp').classList.add('active', 'up');
        if(myVote === -1) document.getElementById('btnVoteDown').classList.add('active', 'down');
        
    } catch(err) {}
    
    const pCount = AppState.personalEmotes ? AppState.personalEmotes.length : 0;
    const btnP = document.getElementById('btnAddToPersonal');
    btnP.innerText = `DODAJ DO PERSONALNYCH (${pCount}/5)`;
    if(AppState.personalEmotes && AppState.personalEmotes.includes(k)) {
        btnP.innerText = "USUŃ Z PERSONALNYCH";
        btnP.style.background = "#ef4444";
        btnP.style.color = "white";
        btnP.onclick = () => { removeFromPersonal(k); closeModal(); };
    } else {
        btnP.style.background = "#38bdf8";
        btnP.style.color = "black";
        btnP.onclick = () => addToPersonal();
    }

    document.getElementById('modalWrap').style.display='flex';
}
window.closeModal = function() { document.getElementById('modalWrap').style.display='none'; }

window.voteEmote = async function(val) {
    if(!AppState.user) return;
    const k = AppState.currentEmoteKey;
    const login = AppState.user.login;
    let currentVote = AppState.currentEmoteVotes ? (AppState.currentEmoteVotes[login] || 0) : 0;
    
    let newVote = (currentVote === val) ? 0 : val;
    
    const upBtn = document.getElementById('btnVoteUp');
    const downBtn = document.getElementById('btnVoteDown');
    let upCount = parseInt(document.getElementById('voteCountUp').innerText);
    let downCount = parseInt(document.getElementById('voteCountDown').innerText);
    
    if(currentVote === 1) upCount--;
    if(currentVote === -1) downCount--;
    
    if(newVote === 1) upCount++;
    if(newVote === -1) downCount++;
    
    document.getElementById('voteCountUp').innerText = upCount;
    document.getElementById('voteCountDown').innerText = downCount;
    
    upBtn.className = 'vote-btn' + (newVote === 1 ? ' active up' : '');
    downBtn.className = 'vote-btn' + (newVote === -1 ? ' active down' : '');
    
    if(newVote === 0) await api(`emotes/${k}/votes/${login}`, "DELETE");
    else await api(`emotes/${k}/votes/${login}`, "PUT", newVote);
    
    if(!AppState.currentEmoteVotes) AppState.currentEmoteVotes = {};
    AppState.currentEmoteVotes[login] = newVote;
}

window.addToPersonal = async function() {
    if(!AppState.user) return;
    if(AppState.personalEmotes.length >= 5) return alert("Masz już 5 emotek personalnych!");
    const k = AppState.currentEmoteKey;
    if(AppState.personalEmotes.includes(k)) return;
    
    AppState.personalEmotes.push(k);
    await saveUserData();
    alert("Dodano do personalnych!");
    closeModal();
}

window.removeFromPersonal = async function(k) {
    if(!AppState.user) return;
    AppState.personalEmotes = AppState.personalEmotes.filter(e => e !== k);
    await saveUserData();
    if(document.getElementById('profile').classList.contains('active')) renderPersonalEmotes(AppState.user.login.toLowerCase());
}

window.assignEmote = async function() {
    if(!AppState.user) return;
    
    // 1. Get current data to check scope
    const currentEmote = AppState.emotes[AppState.currentEmoteKey];
    const isGlobal = currentEmote.scope === 'global';

    // 2. Prepare channels string
    let newChannels = AppState.user.login;
    if(AppState.kickNick) newChannels += "," + AppState.kickNick;

    // If it already has channels, append (don't overwrite if global, though usually global has empty channel)
    if (currentEmote.channel) {
        // Avoid duplicates
        const existing = currentEmote.channel.split(',');
        const toAdd = newChannels.split(',');
        const combined = [...new Set([...existing, ...toAdd])].join(',');
        newChannels = combined;
    }

    // 3. Payload
    const payload = {
        channel: newChannels
    };

    // CRITICAL FIX: Only change scope to 'channel' if it's NOT global
    if (!isGlobal) {
        payload.scope = 'channel';
    }

    await api(`emotes/${AppState.currentEmoteKey}`, "PATCH", payload);
    
    alert("Przypisano emotkę do Twojego kanału (Twitch + Kick)!"); 
    closeModal();
    
    // Odśwież widoki
    loadAllEmotes();
    if(document.getElementById('profile').classList.contains('active')) {
        renderProfileEmotes('channel');
    }
}

// MANAGE & NEW DASHBOARD
window.openEmoteDashboard = function() { 
    if(!AppState.user) return; 
    const select = document.getElementById('emoChannel'); select.innerHTML = '';
    
    // Opcja 1: Twitch (zawsze dostępna)
    const twOpt = document.createElement('option'); 
    twOpt.value = AppState.user.login; 
    twOpt.text = `Twitch: ${AppState.user.display_name}`; 
    select.appendChild(twOpt);
    
    // Opcja 2: Kick (jeśli połączony)
    if(AppState.kickNick) {
        const kickOpt = document.createElement('option');
        kickOpt.value = AppState.kickNick;
        kickOpt.text = `Kick: ${AppState.kickNick}`;
        select.appendChild(kickOpt);
    }
    
    document.getElementById('emotesGalleryView').style.display='none'; 
    document.getElementById('emotesDashboardView').style.display='block';
    
    renderEmoteSlots(); 
}
window.closeEmoteDashboard = function() { 
    document.getElementById('emotesDashboardView').style.display='none'; 
    document.getElementById('emotesGalleryView').style.display='block'; 
    document.getElementById('uploadFormArea').style.display='none';
    loadAllEmotes(); 
}

// UPDATED DELETE LOGIC
window.delEmote = async function(p) { 
    const e = AppState.emotes[p];
    if(!e) return;
    
    // Logika usuwania
    if(AppState.role === 'ADMIN' || e.author === AppState.user.display_name) {
        // Jeśli jesteś autorem lub adminem -> Usuwasz całkowicie z bazy
        if(confirm("USUNĄĆ CAŁKOWICIE Z BAZY DANYCH? (Dla Admina/Autora oznacza trwałe usunięcie)")) {
            await api(`emotes/${p}`, "DELETE");
        }
    } else {
        // Jeśli tylko masz ją przypisaną -> Odpinasz (czyścisz pole channel)
        if(confirm("Odpiąć emotkę z kanału?")) {
            await api(`emotes/${p}`, "PATCH", { channel: "" });
        }
    }
    
    // Odświeżanie
    await loadAllEmotes(); 
    renderEmoteSlots(); 
    renderProfileEmotes('channel'); 
}

window.renameEmote = async function(oldName) {
    const newName = prompt("Nowa nazwa emotki:", oldName);
    if (!newName || newName === oldName) return;
    if (AppState.emotes[newName]) return alert("Ta nazwa jest już zajęta!");

    const data = AppState.emotes[oldName];

    // 1. Create new
    await api(`emotes/${newName}`, "PUT", data);
    // 2. Delete old
    await api(`emotes/${oldName}`, "DELETE");

    alert("Zmieniono nazwę!");
    loadAllEmotes();
    renderProfileEmotes('channel');
}

function renderEmoteSlots() {
    const container = document.getElementById('emoteSlotsContainer');
    if(!container || !AppState.user) return;
    
    const all = AppState.emotes || {};
    // ZMIANA: Dodano warunek && all[k].scope !== 'global'
    // Dzięki temu emotki globalne nie są liczone do osobistych slotów w panelu
    const myEmotes = Object.keys(all).filter(k => all[k].author === AppState.user.display_name && all[k].scope !== 'global').reverse();
    
    container.innerHTML = '';
    
    for(let i = 0; i < 10; i++) {
        const div = document.createElement('div');
        
        if (i < myEmotes.length) {
            const k = myEmotes[i];
            const data = all[k];
            const isPending = data.status === 'pending';
            
            // Apply visual classes
            div.className = `slot-box filled ${isPending ? 'pending' : 'approved'}`;
            
            div.innerHTML = `
                <img src="${data.url}" class="slot-content-img">
                <span class="slot-status-tag">${isPending ? 'OCZEKUJE' : ''}</span>
                <div class="slot-del-overlay" onclick="event.stopPropagation(); delEmote('${k}')">USUŃ</div>
            `;
        } else {
            div.className = 'slot-box';
            div.innerHTML = `<i class="fas fa-plus slot-empty-icon"></i>`;
            div.onclick = function() { openUploadForm(); };
        }
        
        container.appendChild(div);
    }
}

window.openUploadForm = function() {
    document.getElementById('uploadFormArea').style.display = 'block';
}
window.closeUploadForm = function() {
    document.getElementById('uploadFormArea').style.display = 'none';
    document.getElementById('emoName').value = "";
    document.getElementById('emoUrl').value = "";
    document.getElementById('filePreview').style.display='none';
}

window.addEmote = async function() { 
    const all = AppState.emotes || {};
    // ZMIANA: Dodano warunek && all[k].scope !== 'global' do licznika
    const myCount = Object.keys(all).filter(k => all[k].author === AppState.user.display_name && all[k].scope !== 'global').length;
    
    if(myCount >= 10 && AppState.role !== 'ADMIN') {
        alert("Osiągnięto limit 10 emotek! Usuń jakąś, aby dodać nową.");
        return;
    }

    const name = document.getElementById('emoName').value.trim(); 
    const url = document.getElementById('emoUrl').value.trim(); 
    const target = document.getElementById('emoChannel').value;
    
    if(!name || !url) return alert("Brak danych");
    
    // --- ZABEZPIECZENIE PRZED BASE64 (To ratuje Twój transfer) ---
    // LIMIT ZWIĘKSZONY DO 150
    if (url.length > 150 || url.startsWith('data:image')) {
        alert("⛔ STOP! Ten link jest za długi (max 150 znaków) lub jest w formacie Base64.");
        return;
    }
    // -------------------------------------------------------------
    
    const isGlobal = document.getElementById('chkGlobal').checked;
    const scope = (AppState.role === 'ADMIN' && isGlobal) ? 'global' : 'channel';
    
    // Logic: Admin = Approved immediately. User = Pending.
    const status = (AppState.role === 'ADMIN') ? 'approved' : 'pending';
    
    await api(`emotes/${name}`, "PUT", { 
        url: url, 
        author: AppState.user.display_name, 
        scope: scope, 
        channel: (scope==='global'?'':target),
        status: status
    });
    
    closeUploadForm();
    
    loadAllEmotes().then(() => {
        renderEmoteSlots();
        alert(status === 'approved' ? "Opublikowano!" : "Przesłano do akceptacji (oczekuje na admina).");
    });
}
window.previewFile = function() { const f = document.getElementById('emoFile').files[0]; if(f) { const r=new FileReader(); r.onload=e=>{document.getElementById('filePreview').src=e.target.result; document.getElementById('filePreview').style.display='block'; document.getElementById('emoUrl').value = e.target.result;}; r.readAsDataURL(f); } }
window.addModerator = async function() { const nick = document.getElementById('newModNick').value.trim().toLowerCase(); if(nick) { await api(`channels/${AppState.user.login.toLowerCase()}/mods/${nick}`, "PUT", true); fetchMyMods(); document.getElementById('newModNick').value=''; } }

// --- ADMIN PANEL FUNCTIONS (FULL PAGE) ---
window.openAdminPanel = function() {
    if(AppState.role !== 'ADMIN') return;
    switchTab('admin'); // Uses the standard panel switcher now
    
    const all = AppState.emotes || {};
    const pendingKeys = Object.keys(all).filter(k => all[k].status === 'pending');
    
    const grid = document.getElementById('adminQueueGrid');
    grid.innerHTML = '';
    
    if(pendingKeys.length === 0) {
        grid.innerHTML = '<div style="color:#aaa; text-align:center; grid-column:1/-1; padding:50px;">Brak oczekujących emotek 🎉</div>';
    } else {
        pendingKeys.forEach(k => {
            const e = all[k];
            const div = document.createElement('div');
            div.className = 'admin-card-full';
            div.innerHTML = `
                <div style="font-weight:900; color:white; font-size:16px;">${k}</div>
                <img src="${e.url}" onclick="window.open('${e.url}')">
                <div style="font-size:11px; color:#94a3b8; font-weight:600;">Autor: <span style="color:#fff;">${e.author}</span></div>
                <div class="admin-actions">
                    <button class="btn-adm btn-approve" onclick="adminReview('${k}', true)">ZATWIERDŹ</button>
                    <button class="btn-adm btn-reject" onclick="adminReview('${k}', false)">ODRZUĆ</button>
                    <button class="btn-adm btn-ban-user" onclick="banUser('${e.author}')">BAN AUTHOR</button>
                </div>
            `;
            grid.appendChild(div);
        });
    }
    
    // NEW: RENDER SHOP MANAGER
    renderAdminShop();
}

window.adminReview = async function(key, approved) {
    if(approved) {
        const data = AppState.emotes[key];
        data.status = 'approved';
        await api(`emotes/${key}`, "PUT", data);
    } else {
        await api(`emotes/${key}`, "DELETE");
    }
    
    // Refresh local data & UI
    await loadAllEmotes();
    openAdminPanel(); // Refresh list
}

// --- NEW: BAN SYSTEM ---
window.banUser = async function(username) {
    if(AppState.role !== 'ADMIN') return;
    if(!username) return;
    
    const nick = username.trim().toLowerCase();
    if(confirm(`Czy na pewno chcesz zbanować użytkownika: ${nick}?`)) {
        const res = await api(`banned_users/${nick}`, "PUT", true);
        if(res !== null) alert(`Użytkownik ${nick} został zbanowany.`);
        else alert("Błąd API: Sprawdź czy zaktualizowałeś Firebase Rules!");
    }
}

async function checkBanStatus(login) {
    try {
        const res = await fetch(`${DB_URL}/banned_users/${login}.json`);
        const isBanned = await res.json();
        if(isBanned === true) {
            document.getElementById('bannedScreen').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    } catch(e) {}
}

// --- NEW: ADMIN SHOP MANAGER ---
async function renderAdminShop() {
    const grid = document.getElementById('adminShopGrid');
    if(!grid) return;
    grid.innerHTML = 'Ładowanie sklepu...';
    
    // Fetch both active and storage to know current state
    const activeRes = await fetch(`${DB_URL}/shop/active.json`);
    const storageRes = await fetch(`${DB_URL}/shop/storage.json`);
    
    const active = activeRes.ok ? await activeRes.json() || {} : {};
    const storage = storageRes.ok ? await storageRes.json() || {} : {};
    
    grid.innerHTML = '';
    
    CATALOG.forEach(item => {
        const isActive = active.hasOwnProperty(item.name);
        // Price priority: Active > Storage > Default
        const currentPrice = isActive ? active[item.name] : (storage[item.name] || item.price);
        
        const div = document.createElement('div');
        div.className = 'admin-shop-card';
        
        let preview = item.category === 'badge' ? `<img src="${item.value}">` : `<div class="preview-box" style="${item.previewStyle}">Aa</div>`;
        
        div.innerHTML = `
            ${preview}
            <div class="admin-shop-info">
                <div class="admin-shop-name">${item.name}</div>
                <input type="number" id="price_${item.name.replace(/\s/g, '')}" class="admin-shop-price-input" value="${currentPrice}">
            </div>
            <label class="switch">
                <input type="checkbox" id="check_${item.name.replace(/\s/g, '')}" ${isActive ? 'checked' : ''}>
                <span class="slider"></span>
            </label>
        `;
        grid.appendChild(div);
    });
}

window.saveShopConfig = async function() {
    if(AppState.role !== 'ADMIN') return;
    
    const newActive = {};
    const newStorage = {};
    
    CATALOG.forEach(item => {
        const id = item.name.replace(/\s/g, '');
        const isChecked = document.getElementById(`check_${id}`).checked;
        const priceVal = parseInt(document.getElementById(`price_${id}`).value);
        
        if(isChecked) {
            newActive[item.name] = priceVal;
        } else {
            newStorage[item.name] = priceVal;
        }
    });
    
    // Send to API
    await api('shop/active', 'PUT', newActive);
    await api('shop/storage', 'PUT', newStorage);
    
    alert("Sklep zaktualizowany!");
    // Refresh local state
    AppState.shopActive = newActive;
    renderShop();
}

// HELPERS
function updateCoinDisplay() { 
    document.getElementById('coinCount').innerText = AppState.coins; 
    
    const paints = CATALOG.filter(i=>i.category==='paint').length; 
    const myPaints = AppState.owned.filter(n => {
        const item = CATALOG.find(i=>i.name===n);
        return item && item.category === 'paint';
    }).length;
    
    // CHANGE: Added "Collection" text
    document.getElementById('collectionCount').innerText = `${myPaints}/${paints}`;
}
function fireDownloadConfetti() { 
    confetti({particleCount:100,spread:70,origin:{y:0.6}}); 
    // Dodano przekierowanie do GitHub po 1 sekundzie (po wybuchu konfetti)
    setTimeout(() => { window.open('https://github.com/GatoTV/panel', '_blank'); }, 1000);
}
function fireConfetti(shop) { if(shop) confetti({particleCount:50,spread:60,origin:{x:0.5,y:0.5}}); }
window.togglePreviewTheme = function(el) { el.classList.toggle('light'); }

// API FIX: OPTIMIZED VERSION (NO TIMESTAMP)
async function api(path, method="GET", body=null) { 
    const opts={ method, headers: {} }; 
    if(body !== null) { // FIX: Allow false/0
        opts.body=JSON.stringify(body); 
    }
    try {
        // ZOPTYMALIZOWANO: Usunięto "?t=" - przeglądarka użyje cache
        const url = `${DB_URL}/${path}.json`;
        const r = await fetch(url, opts); 
        return r.json();
    } catch(e) { return null; } 
}

// ENCYCLOPEDIA
window.openEncyclopedia = function() {
    const grid = document.getElementById('encyclopediaGrid');
    grid.innerHTML = '';
    
    CATALOG.forEach(item => {
        const owned = AppState.owned.includes(item.name);
        const div = document.createElement('div');
        div.className = `encyclo-item ${owned ? 'owned' : ''}`;
        
        let view = item.category === 'badge' ? `<img src="${item.value}" style="width:30px;">` : `<div style="${item.previewStyle}; font-size:20px;">Aa</div>`;
        
        div.innerHTML = `${view}<div class="encyclo-name">${item.name}</div>`;
        grid.appendChild(div);
    });
    
    document.getElementById('modalEncyclopedia').style.display = 'flex';
}

// DAILY
const DC = 86400000; // 24 hours
function checkDailyBonus() {
    const btn = document.getElementById('btnDaily'); if(!btn) return;
    
    const last = AppState.lastDaily;
    const now = Date.now();
    
    if(last && now - last < DC) {
        btn.disabled = true;
        const diff = DC - (now - last);
        const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000); // Added seconds for short timer
        btn.innerHTML = `<i class="fas fa-clock"></i> ${hrs}h ${mins}m ${secs}s`;
    } else {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-gift"></i> ODBIERZ +25`;
    }
}
window.claimDailyBonus = async function() {
    if(!AppState.user) return;
    if (Date.now() - AppState.lastDaily < DC) return alert("Musisz poczekać 24h!");
    
    AppState.coins += 25; 
    AppState.lastDaily = Date.now();
    updateCoinDisplay(); 
    fireConfetti(true);
    checkDailyBonus();
    
    // EXPLICIT SAVE TO ENSURE PERSISTENCE
    const login = AppState.user.login.toLowerCase();
    await api(`users/${login}/coins`, "PUT", AppState.coins);
    await api(`users/${login}/lastDaily`, "PUT", AppState.lastDaily);
    
    await saveUserData();
}
window.redeemCode = async function() {
    if(!AppState.user) return;
    const c = prompt("Kod:");
    alert("Brak aktywnych kodów.");
}

window.previewBpItemByName = function(name) {
    if (!name || typeof name !== 'string') return;
    const item = CATALOG.find(i => i.name === name);
    if (item) {
        updatePreviewUI(item);
    }
}

// BATTLEPASS LOGIC
const BP_COOLDOWN = 21600000; // 6 hours

function renderBattlepass() {
    const track = document.getElementById('bpTrack');
    if(!track) return;
    track.innerHTML = '';

    // Calculate Level
    const currentLevel = Math.floor(AppState.bpXp / 100) + 1;
    const currentXpInLevel = AppState.bpXp % 100;
    
    // Update Header
    document.getElementById('bpCurrentLevel').innerText = currentLevel;
    document.getElementById('bpProgressBar').style.width = `${currentXpInLevel}%`;
    document.getElementById('bpXpText').innerText = `${currentXpInLevel} / 100 XP`;
    
    if(AppState.hasPremium) document.getElementById('bpPremiumBadge').style.display = 'inline-block';

    BP_LEVELS.forEach(step => {
        const isCompleted = currentLevel > step.lvl;
        const isCurrent = currentLevel === step.lvl;
        
        const div = document.createElement('div');
        div.className = `bp-step ${isCompleted ? 'completed' : ''}`;
        
        // Free Node
        const freeNode = `
            <div class="bp-free-tag">DARMOWY</div>
            <div class="bp-node-free ${isCompleted ? 'bp-reward-claimed' : ''}" 
                 title="Darmowa Nagroda: ${step.free.val}"
                 onmouseenter="previewBpItemByName('${step.free.val}')"
                 onmouseleave="updatePreview(AppState.loadout)">
                <img src="${step.free.img}" class="bp-node-img">
                ${!isCompleted && !isCurrent ? '<div class="bp-lock-overlay"><i class="fas fa-lock"></i></div>' : ''}
            </div>
        `;
        
        // Premium Node
        const isPremLocked = !AppState.hasPremium;
        const premNode = `
            <div class="bp-node-premium ${isCompleted && !isPremLocked ? 'bp-reward-claimed' : ''}" title="Premium: ${step.prem.val}"
                 onmouseenter="previewBpItemByName('${step.prem.val}')" onmouseleave="updatePreview(AppState.loadout)">
                <img src="${step.prem.img}" class="bp-node-img">
                ${isPremLocked ? '<div class="bp-lock-overlay"><i class="fas fa-lock" style="color:#facc15;"></i></div>' : 
                  (!isCompleted && !isCurrent ? '<div class="bp-lock-overlay"><i class="fas fa-lock"></i></div>' : '')}
            </div>
            <div class="bp-premium-tag">GOLD</div>
        `;

        div.innerHTML = `
            ${freeNode}
            <div class="bp-level-indicator">${step.lvl}</div>
            ${premNode}
        `;
        track.appendChild(div);
    });
    
    checkBpTimer();
}

function checkBpTimer() {
    const btn = document.getElementById('btnClaimBpXp');
    if(!btn) return;
    const now = Date.now();
    const diff = now - (AppState.lastBpClaim || 0);
    
    if(diff < BP_COOLDOWN) {
        btn.disabled = true;
        const left = BP_COOLDOWN - diff;
        const h = Math.floor(left/(1000*60*60));
        const m = Math.floor((left%(1000*60*60))/(1000*60));
        const s = Math.floor((left%(1000*60))/1000);
        btn.innerHTML = `<span style="font-size:10px; opacity:0.8;">ODNOWIENIE ZA</span> ${h}h ${m}m ${s}s`;
    } else {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-bolt"></i> ODBIERZ +50 XP`;
    }
}

window.claimBpXp = async function() {
    if(!AppState.user) return;
    if(Date.now() - (AppState.lastBpClaim || 0) < BP_COOLDOWN) return;
    
    AppState.bpXp = (AppState.bpXp || 0) + 50;
    AppState.lastBpClaim = Date.now();
    
    fireConfetti(true);
    renderBattlepass();
    saveUserData();
}

// CLOUD SYNC - OPTIMIZED
async function fetchCloudData() {
    if(!AppState.user) return;
    try {
        const login = AppState.user.login.toLowerCase();
        
        // 0. CHECK BAN STATUS
        await checkBanStatus(login);
        
        // 1. FETCH ROLE FROM API (NEW)
        const roleRes = await fetch(`${DB_URL}/roles/${login}.json`);
        const roleData = roleRes.ok ? await roleRes.json() : null;
        AppState.role = (roleData === "ADMIN" || login === 'guest_user') ? "ADMIN" : "USER";
        
        // Update UI based on role
        const badge = document.getElementById('userRoleBadge');
        badge.style.display = 'flex';
        badge.className = `role-badge role-${AppState.role === 'ADMIN' ? 'admin' : 'user'}`;
        badge.innerText = AppState.role;
        if(AppState.role === 'ADMIN') {
            badge.title = "Kliknij, aby otworzyć Panel Moderacji";
            document.getElementById('adminScopeOption').style.display = 'block';
        }
        document.getElementById('profileRoleTag').innerText = AppState.role;

        // 2. FETCH USER DATA
        const userRes = await fetch(`${DB_URL}/users/${login}.json`); 
        const userData = userRes.ok ? (await userRes.json()) : null;
        
        if (userData) {
            AppState.coins = userData.coins || 0;
            AppState.owned = userData.owned || [];
            AppState.lastDaily = userData.lastDaily || 0;
            AppState.bpXp = userData.bpXp || 0;
            AppState.lastBpClaim = userData.lastBpClaim || 0;
            AppState.hasPremium = userData.hasPremium || false;
            AppState.personalEmotes = userData.personalEmotes || [];
        } else {
            AppState.coins = 100;
            AppState.owned = [];
            AppState.lastDaily = 0;
            AppState.bpXp = 0;
            await saveUserData();
        }
        
        // --- FREE CLASSIC BADGE LOGIC ---
        if (!AppState.owned.includes("Classic")) {
            AppState.owned.push("Classic");
        }
        // --------------------------------

        // 3. FETCH LOADOUT
        const loadoutRes = await fetch(`${DB_URL}/premium/${login}.json`);
        const loadoutData = loadoutRes.ok ? (await loadoutRes.json() || {}) : {};
        AppState.loadout = loadoutData;

        // 4. FETCH SHOP (ACTIVE)
        const shopRes = await fetch(`${DB_URL}/shop/active.json`);
        const activeShop = shopRes.ok ? await shopRes.json() : null;

        if (!activeShop) {
            // INITIALIZATION (Fallback)
            const paints = CATALOG.filter(i => i.category === 'paint');
            const badges = CATALOG.filter(i => i.category === 'badge');
            
            const activeObj = {};
            const storageObj = {};

            paints.slice(0, 5).forEach(i => activeObj[i.name] = i.price);
            badges.slice(0, 5).forEach(i => activeObj[i.name] = i.price);
            
            paints.slice(5).forEach(i => storageObj[i.name] = i.price);
            badges.slice(5).forEach(i => storageObj[i.name] = i.price);

            AppState.shopActive = activeObj;
            
            await api('shop/active', 'PUT', activeObj);
            await api('shop/storage', 'PUT', storageObj);
        } else {
            AppState.shopActive = activeShop;
        }
        
        updateCoinDisplay();
        checkDailyBonus();
        updatePreview(loadoutData);
        renderShop();
        renderProfileInventory();
        fetchMyMods();
        
    } catch(e) { console.error("Cloud Error", e); }
    loadAllEmotes();
    
    setInterval(checkDailyBonus, 1000);
    setInterval(checkBpTimer, 1000);
}

async function saveUserData() {
    if(!AppState.user) return;
    const login = AppState.user.login.toLowerCase();
    const payload = {
        coins: AppState.coins,
        owned: AppState.owned,
        lastDaily: AppState.lastDaily,
        bpXp: AppState.bpXp,
        lastBpClaim: AppState.lastBpClaim,
        hasPremium: AppState.hasPremium,
        personalEmotes: AppState.personalEmotes
    };
    await api(`users/${login}`, "PATCH", payload);
}

async function fetchMyMods() {
    try {
        const res = await fetch(`${DB_URL}/channels/${AppState.user.login.toLowerCase()}/mods.json`);
        renderModsList(res.ok ? (await res.json() || {}) : {});
    } catch(e) {}
}
function renderModsList(mods) {
    const list = document.getElementById('modsList');
    if(!list) return; list.innerHTML = '';
    Object.keys(mods).forEach(modNick => {
        const div = document.createElement('div'); div.className = 'mod-item';
        div.innerHTML = `<span>${modNick}</span> <button class="btn-remove-mod" onclick="removeModerator('${modNick}')">Usuń</button>`;
        list.appendChild(div);
    });
}
window.removeModerator = async function(nick) { if(confirm("Usunąć?")) { await api(`channels/${AppState.user.login.toLowerCase()}/mods/${nick}`, "DELETE"); fetchMyMods(); } }
</script>
</body>
</html>
