// ==UserScript==
// @name         Gato.TV Plugin (Kick V58 - Intelligent Clean)
// @namespace    http://tampermonkey.net/
// @version      58.1
// @description  Silnik V58.1: Naprawione przypiÄ™te wiadomoÅ›ci, ulepszone powiadomienia i miganie karty.
// @author       Gato
// @match        https://kick.com/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    console.log("ðŸ’Ž Gato V58.1: Intelligent Engine Loaded");

    // ===================== KONFIGURACJA =====================
    const API_URL = "https://wersjabeta-8cf8c-default-rtdb.europe-west1.firebasedatabase.app/";
    
    // ODÅšWIEÅ»ANIE: 15 sekund
    const REFRESH_RATE = 15000; 
    const RENDER_RATE = 200; 
    const MENU_ICON = "https://cdn-icons-png.flaticon.com/128/616/616430.png";
    const COSMETICS_URL = "https://gatotv.github.io/panel/"; 

    // ===================== STATE =====================
    let PREMIUM = {};
    let EMOTES = {};
    let EMOTE_KEYS = [];
    let DATA_LOADED = false;
    let CURRENT_CHANNEL = "";
    
    let ETAG_PREMIUM = null;
    let ETAG_EMOTES = null;

    let RAW_EMOTES = {}; // Emotki z API Gato
    let CURRENT_SEVENTV_ID = null; // ID zestawu dla obecnego kanaÅ‚u
    let SEVENTV_EMOTES = {};

    // GUI State
    let EMOTE_TAB = 'channel'; 
    let menuOpen = false;
    let FORCE_GREEN = localStorage.getItem('gato_force_green') !== 'false'; // Default true
    if (FORCE_GREEN) document.body.classList.add('gato-green-enabled');
    let HIDE_PINNED = localStorage.getItem('gato_hide_pinned') === 'true'; // Default false
    let ENLARGE_CHAT = localStorage.getItem('gato_enlarge_chat') === 'true'; // Default false
    if (ENLARGE_CHAT) document.body.classList.add('gato-enlarge-enabled');

    // AUTOCOMPLETE STATE
    let acOpen = false;
    let acMatches = [];
    let acIndex = 0;
    let MENTIONS_LOG = {}; // { author: [{text, time, timestamp, isSelf, author}, ...], ... }
    let NEW_MENTIONS_COUNT = 0; 
    let PROCESSED_MESSAGES = new Map(); // Sig -> { count, lastSeen }
    let MY_USERNAME = null;

    // Title Blink State
    let isTitleBlinking = false;
    let blinkInterval = null;
    let blinkState = false;
    let titleBeforeBlinking = document.title;

    // ===================== CSS =====================
    const style = document.createElement("style");
    style.innerHTML = `
        /* --- CORE --- */
        body.gato-green-enabled #chat-chatroom button.font-bold:not(.gato-vip) {
            color: #00ff00 !important;
            -webkit-text-fill-color: #00ff00 !important;
            text-shadow: none !important;
            background: none !important;
            text-decoration: none !important;
        }
        .gato-vip {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            display: inline !important;
            background-clip: text !important;
            -webkit-background-clip: text !important;
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            font-weight: 900 !important;
        }
        .gato-vip * { color: transparent !important; -webkit-text-fill-color: transparent !important; background: none !important; }
        .gato-vip.gato-solid, .gato-vip.gato-solid * {
            background: none !important; background-clip: border-box !important; -webkit-background-clip: border-box !important;
            color: inherit !important; -webkit-text-fill-color: inherit !important;
        }
        .gato-green-nick {
            color: #00ff00 !important;
            -webkit-text-fill-color: #00ff00 !important;
            background: none !important;
            text-shadow: none !important;
            filter: none !important;
        }
        
        /* --- BADGE FIX --- */
        .gato-badge-icon { 
            width: 18px !important; 
            height: 18px !important; 
            margin-right: 4px !important; 
            vertical-align: middle !important; 
            display: inline-block !important; 
            margin-top: -4px !important;
            margin-bottom: -4px !important;
            position: relative !important;
            top: 5px !important; 
        }
        
        .gato-emote { height: 28px; margin: 0 2px; vertical-align: middle; object-fit: contain; cursor: pointer; transition: transform 0.1s; display: inline-block; }
        .gato-emote:hover { transform: scale(1.4); z-index: 10; position: relative; }

        @keyframes gatoShine { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
        @keyframes gatoRainbow { 0%{filter: hue-rotate(0deg);} 100%{filter: hue-rotate(360deg);} }

        /* --- GUI --- */
        #gato-menu { position: fixed; bottom: 100px; right: 20px; width: 350px; height: 450px; background: #09090b; border: 2px solid #00ff00; z-index: 9999999; display: none; flex-direction: column; color: white; font-family: sans-serif; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .gato-menu-header { background: #18181b; padding: 12px; font-weight: bold; color: #efeff1; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border-bottom: 1px solid #333; letter-spacing: 0.5px; }
        .gato-menu-tabs { display: flex; background: #0e0e10; border-bottom: 1px solid #333; }
        .gato-tab { flex: 1; text-align: center; padding: 8px 0; font-size: 11px; font-weight: bold; cursor: pointer; color: #adadb8; background: #18181b; transition: 0.2s; border-bottom: 2px solid transparent; }
        .gato-tab:hover { background: #26262c; color: #fff; }
        .gato-tab.active { background: #26262c; color: #fff; border-bottom: 2px solid #00ff00; }
        .gato-menu-search-container { padding: 8px 10px; background: #18181b; border-bottom: 1px solid #333; }
        #gatoSearchInput { width: 100%; background: #26262c; border: 1px solid #444; color: #efeff1; padding: 6px 8px; border-radius: 4px; font-size: 12px; outline: none; }
        #gatoSearchInput:focus { border-color: #00ff00; }
        .gato-menu-content { padding: 10px; overflow-y: auto; display: grid; flex: 1; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 5px; }
        .gato-menu-item { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: #26262c; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .gato-menu-item:hover { background: #3f3f46; transform: scale(1.05); }
        .gato-menu-item img { max-width: 35px; max-height: 35px; object-fit: contain; }
        .gato-menu-empty { grid-column: 1 / -1; text-align: center; color: #adadb8; padding: 20px; font-size: 12px; }
        .gato-menu-footer { padding: 10px; border-top: 1px solid #333; background: #0e0e10; }
        .gato-cosmetics-btn { display: block; width: 100%; padding: 8px 0; background: #00ff00; color: black !important; text-align: center; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .gato-cosmetics-btn:hover { background: #00cc00; }

        /* --- TOGGLE SWITCH --- */
        .gato-toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #18181b; border-radius: 6px; margin-bottom: 10px; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .gato-toggle-row:hover { border-color: #555; background: #202024; }
        .gato-toggle-switch { width: 40px; height: 22px; background: #3f3f46; border-radius: 20px; position: relative; transition: 0.3s; }
        .gato-toggle-switch.active { background: #00ff00; }
        .gato-toggle-knob { 
            width: 16px; height: 16px; background: white; border-radius: 50%; 
            position: absolute; top: 3px; left: 3px; transition: 0.3s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        .gato-toggle-switch.active .gato-toggle-knob { transform: translateX(18px); }
        .gato-toggle-label { font-size: 12px; font-weight: bold; color: #efeff1; display: flex; align-items: center; gap: 6px; }

        /* --- AUTOCOMPLETE GUI --- */
        #gato-autocomplete {
            position: fixed;
            z-index: 99999999;
            background: #18181b;
            border: 1px solid #00ff00;
            border-radius: 6px;
            padding: 5px;
            display: none;
            flex-direction: row;
            gap: 5px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            max-width: 400px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .gato-ac-item {
            padding: 5px 10px;
            border-radius: 4px;
            background: #26262c;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .gato-ac-item img { height: 20px; width: auto; }
        .gato-ac-item.selected {
            background: #00ff00;
            color: #000;
            border-color: #00cc00;
        }

        /* --- BUTTONS CONTAINER --- */
        #gato-buttons-container {
            display: flex;
            gap: 5px;
            margin-top: -5px;
            width: 100%;
        }
        body.gato-enlarge-enabled #gato-buttons-container {
            margin-top: 0 !important;
        }
        body.gato-enlarge-enabled .gato-panel-btn {
            padding: 2px !important;
            font-size: 9px !important;
            line-height: 12px !important;
        }
        .gato-panel-btn {
            flex: 1;
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: 0.2s;
        }
        .gato-panel-btn:hover { background: #003300; }
        
        #gato-mentions-ui {
            position: fixed;
            bottom: 100px; right: 20px;
            width: 550px;
            height: 400px;
            background: #09090b;
            border: 2px solid #00ff00;
            z-index: 99999999;
            display: none;
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            color: #fff;
            font-family: sans-serif;
        }
        .gato-m-header { padding: 12px; background: #18181b; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; letter-spacing: 0.5px; }
        .gato-m-content { flex: 1; overflow-y: auto; padding: 0; display: flex; }
        .gato-m-authors { width: 160px; background: #0e0e10; border-right: 1px solid #333; padding: 0; overflow-y: auto; }
        .gato-m-row { display: flex; border-bottom: 1px solid #333; padding: 8px 0; }
        .gato-m-author { color: #888; font-weight: 600; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #1f1f23; transition: 0.2s; font-size: 12px; }
        .gato-m-author:hover { background: #18181b; color: #fff; }
        .gato-m-author.active { background: #00ff00; color: #000; font-weight: 800; }
        .gato-m-messages { flex: 1; padding: 15px; overflow-y: auto; background: #000; }
        .gato-m-msg { font-size: 13px; word-break: break-word; padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; background: #18181b; border: 1px solid #27272a; display: flex; flex-direction: column; }
        .gato-m-empty { text-align: center; padding: 20px; color: #666; }

        /* --- SETTINGS MENU --- */
        #gato-settings-menu { position: fixed; bottom: 100px; right: 20px; width: 300px; background: #09090b; border: 2px solid #00ff00; z-index: 9999999; display: none; flex-direction: column; color: white; font-family: sans-serif; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        .gato-settings-header { background: #18181b; padding: 12px; font-weight: bold; color: #efeff1; display: flex; justify-content: space-between; align-items: center; font-size: 14px; border-bottom: 1px solid #333; letter-spacing: 0.5px; }
        .gato-settings-content { padding: 10px; }

    `;
    document.head.appendChild(style);

    // ===================== SMART DATA FETCHING (ETAG) =====================
    async function smartFetch(endpoint, currentEtag) {
        try {
            const headers = {};
            if (currentEtag) {
                headers['If-None-Match'] = currentEtag;
            }

            const response = await fetch(`${API_URL}${endpoint}.json`, { headers });

            if (response.status === 304) {
                return { changed: false, etag: currentEtag, data: null };
            }

            if (response.ok) {
                const newEtag = response.headers.get('ETag');
                const data = await response.json();
                return { changed: true, etag: newEtag, data: data };
            }
        } catch (err) {
            console.error("Fetch error:", err);
        }
        return { changed: false, etag: currentEtag, data: null };
    }

    async function updateChannel7TV() {
        if (!CURRENT_CHANNEL) return;
        
        // Pobierz ID z danych PREMIUM dla obecnego kanaÅ‚u
        const channelData = PREMIUM[CURRENT_CHANNEL];
        const newId = channelData ? channelData.sevenTvId : null;

        if (newId !== CURRENT_SEVENTV_ID) {
            CURRENT_SEVENTV_ID = newId;
            SEVENTV_EMOTES = {};
            
            if (newId) {
                try {
                    const r = await fetch(`https://7tv.io/v3/emote-sets/${newId}`);
                    if(r.ok) {
                        const d = await r.json();
                        d.emotes.forEach(e => {
                            SEVENTV_EMOTES[e.name] = { url: `https:${e.data.host.url}/2x.webp`, scope: 'channel', channel: CURRENT_CHANNEL };
                        });
                        console.log(`ðŸ’Ž 7TV: ZaÅ‚adowano ${d.emotes.length} emotek dla kanaÅ‚u ${CURRENT_CHANNEL}`);
                    }
                } catch(e) { console.error("7TV Error", e); }
            }
            rebuildEmotes();
        }
    }

    function rebuildEmotes() {
        EMOTES = { ...RAW_EMOTES, ...SEVENTV_EMOTES };
        EMOTE_KEYS = Object.keys(EMOTES).sort((a,b) => b.length - a.length);
        renderEmoteMenu(document.getElementById('gatoSearchInput')?.value || "");
    }

    async function fetchData() {
        const pResult = await smartFetch('premium', ETAG_PREMIUM);
        if (pResult.changed) {
            ETAG_PREMIUM = pResult.etag;
            let newP = {};
            if (pResult.data) Object.keys(pResult.data).forEach(k => newP[k.toLowerCase().trim()] = pResult.data[k]);
            PREMIUM = newP;
            updateChannel7TV(); // SprawdÅº czy zmieniÅ‚ siÄ™ ID 7TV po aktualizacji danych
            console.log("ðŸ’Ž Pobranno nowe Painty!");
        }

        const eResult = await smartFetch('emotes', ETAG_EMOTES);
        if (eResult.changed) {
            ETAG_EMOTES = eResult.etag;
            RAW_EMOTES = eResult.data || {};
            rebuildEmotes();
            console.log("ðŸ’Ž Pobranno nowe Emotki!");
        }

        if (!DATA_LOADED && (PREMIUM || EMOTES)) {
            DATA_LOADED = true;
            console.log("âœ… Gato.TV: System gotowy.");
        }
    }

    // ===================== INTELLIGENT CLEANUP =====================
    function cleanInterface() {
        // 1. Usuwanie nagÅ‚Ã³wka "Czat"
        const chatHeaders = document.querySelectorAll('.relative.flex.min-h-\\[38px\\].shrink-0.items-center.justify-between');
        chatHeaders.forEach(h => {
            if(h.textContent.includes('Czat') || h.querySelector('span')?.innerText === 'Czat') {
                h.style.display = 'none';
            }
        });

        // 2. Usuwanie rankingu "Najlepsi darczyÅ„cy"
        const leaderboards = document.querySelectorAll('.flex.flex-row.px-2.font-semibold');
        leaderboards.forEach(l => {
            if(l.textContent.includes('Najlepsi darczyÅ„cy') || l.querySelector('img[alt="Gift Rank 1"]')) {
                l.style.display = 'none';
            }
        });

        // 3. Usuwanie widgetu "Najlepsi darczyÅ„cy miesiÄ…ca"
        const leaderboardsV2 = document.querySelectorAll('.relative.flex.flex-col.justify-end.text-sm.font-medium');
        leaderboardsV2.forEach(w => {
            if(w.textContent.includes('Najlepsi darczyÅ„cy') || w.querySelector('img[alt="Gift Rank 1"]')) {
                w.style.display = 'none';
            }
        });

        // 4. Usuwanie przycisku "Scroll to bottom / New Messages"
        const scrollSeparators = document.querySelectorAll('button.flex.w-full.items-center.gap-2');
        scrollSeparators.forEach(b => {
            if(b.querySelector('svg') || b.innerHTML.includes('path d="M30 25H2V28.5H30V25Z"')) {
                b.style.display = 'none';
            }
        });

        // 5. Usuwanie przypiÄ™tej wiadomoÅ›ci (NAPRAWIONE - nie usuwa odznak modÃ³w)
        const pinnedMessages = document.querySelectorAll('[data-testid="pinned-message-content"]');
        pinnedMessages.forEach(content => {
            // Szukamy gÅ‚Ã³wnego kontenera przypiÄ™tej wiadomoÅ›ci (BEZPIECZNIEJ)
            // Zamiast closest() ktÃ³ry moÅ¼e pÃ³jÅ›Ä‡ za daleko, idziemy max 4 poziomy w gÃ³rÄ™
            let container = content.parentElement;
            let found = false;
            for(let i=0; i<4; i++) {
                if(!container) break;
                if(container.classList.contains('bg-surface-highest') || container.classList.contains('border-outline-decorative')) {
                    found = true;
                    break;
                }
                container = container.parentElement;
            }
            if(!found) container = content.parentElement?.parentElement?.parentElement;

            if (container) {
                // FIX: Upewnij siÄ™, Å¼e nie ukrywamy normalnej wiadomoÅ›ci czatu (chroni badge moderatorÃ³w)
                if (container.tagName === 'BODY' || container.id === 'chat-chatroom' || container.querySelector('.chat-entry-content') || container.classList.contains('chat-entry') || container.classList.contains('group')) return;
                
                container.style.display = HIDE_PINNED ? 'none' : '';
            }
        });

        // 6. Enlarge Chat (Ukrywanie dolnych blokÃ³w)
        const elementsToHide = [];
        const sendBtn = document.getElementById('send-message-button');
        if(sendBtn) elementsToHide.push(sendBtn);
        
        const pointsBtn = document.querySelector('[data-testid="channel-points-button"]');
        if(pointsBtn) {
            const container = pointsBtn.closest('.flex.gap-x-1');
            if(container) elementsToHide.push(container);
        }
        
        const settingsBtn = Array.from(document.querySelectorAll('button')).find(b => b.innerHTML.includes('M25.7,17.3'));
        if(settingsBtn) elementsToHide.push(settingsBtn);

        elementsToHide.forEach(el => {
            if(ENLARGE_CHAT) el.style.display = 'none';
            else if(el.style.display === 'none') el.style.display = '';
        });
    }

    // ===================== CORE LOOP =====================
    let prevChannel = "";
    function renderLoop() {
        if (!DATA_LOADED) return;
        const path = location.pathname.split('/').filter(p=>p);
        if(path.length && !['dashboard','settings'].includes(path[0])) CURRENT_CHANNEL = path[0].toLowerCase();
        
        if (CURRENT_CHANNEL !== prevChannel) {
            prevChannel = CURRENT_CHANNEL;
            updateChannel7TV();
        }

        const chatRoot = document.querySelector('#chat-chatroom') || document.body;
        const frameTime = Date.now() / 1000;

        const buttons = chatRoot.querySelectorAll('button[title]');
        buttons.forEach(btn => updateButtonState(btn, frameTime));

        const textNodesToProcess = chatRoot.querySelectorAll('.group div:not([data-gato-done]), .chat-entry-content:not([data-gato-done])');
        textNodesToProcess.forEach(processContentNode);

        injectAutocompleteGUI(); 
        injectInterface(); 
        cleanInterface(); 
        scanMentions();
    }

    // ===================== NICKNAMES LOGIC =====================
    function updateButtonState(btn, frameTime) {
        const raw = btn.getAttribute('title');
        if (!raw) return;
        const u = raw.trim().toLowerCase();

        const userData = PREMIUM[u];
        const isPremium = !!userData;
        const alreadyVip = btn.classList.contains('gato-vip');

        if (isPremium) {
            setPremium(btn, userData, frameTime);
        } else {
            if (FORCE_GREEN) {
                if(alreadyVip || btn.style.color) setGreen(btn);
            } else {
                if (btn.dataset.gatoPaintId === 'green') resetToDefault(btn);
            }
        }
    }

    function setGreen(btn) {
        if (btn.dataset.gatoPaintId === 'green') return;
        btn.classList.remove('gato-vip', 'gato-solid');
        btn.classList.add('gato-green-nick');
        btn.dataset.gatoPaintId = 'green';
        removeBadge(btn);
    }
    
    function resetToDefault(btn) {
        btn.classList.remove('gato-vip', 'gato-solid', 'gato-green-nick');
        if (btn.dataset.gatoPaintId !== 'green') {
            btn.style.removeProperty('color');
            btn.style.removeProperty('-webkit-text-fill-color');
            btn.style.removeProperty('background');
            btn.style.removeProperty('text-shadow');
            btn.style.removeProperty('filter');
            btn.style.removeProperty('animation');
            btn.style.removeProperty('animation-delay');
            btn.style.removeProperty('background-image');
            btn.style.removeProperty('background-size');
            btn.style.removeProperty('background-clip');
            btn.style.removeProperty('-webkit-background-clip');
        }
        delete btn.dataset.gatoPaintId;
        removeBadge(btn);
    }

    function setPremium(btn, userData, frameTime) {
        const p = userData ? userData.paint : null;
        if (!p) { setGreen(btn); return; }

        const badgeUrl = userData.badge || '';
        const currentId = p.type + (p.value || '') + (p.filter || '') + badgeUrl;

        if (btn.dataset.gatoPaintId === currentId) return;

        btn.dataset.gatoPaintId = currentId;
        btn.classList.add('gato-vip');
        btn.style.removeProperty('color');

        const now = frameTime;

        if (p.type === 'color') {
            btn.classList.add('gato-solid');
            btn.style.setProperty('color', p.value, 'important');
            btn.style.setProperty('-webkit-text-fill-color', p.value, 'important');
            btn.style.setProperty('background', 'none', 'important');
            btn.style.removeProperty('animation');
            btn.style.removeProperty('animation-delay');
            btn.style.removeProperty('filter');
            if(p.shadow) btn.style.setProperty('text-shadow', `0 0 5px ${p.shadow}`, 'important');
        } 
        else if (p.type === 'gradient') {
            btn.classList.remove('gato-solid');
            applyGradient(btn, p.value);
            
            if(p.filter) {
                btn.style.setProperty('filter', p.filter, 'important');
                btn.style.setProperty('background-size', '100% auto', 'important'); 
                btn.style.removeProperty('animation'); 
                btn.style.removeProperty('animation-delay');
            } else {
                btn.style.setProperty('background-size', '200% auto', 'important');
                const duration = 9;
                const delay = -(now % duration);
                btn.style.setProperty('animation', `gatoShine ${duration}s linear infinite`, 'important');
                btn.style.setProperty('animation-delay', `${delay}s`, 'important'); 
                btn.style.removeProperty('filter');
            }
        }
        else if (p.type === 'animated-rainbow') {
            btn.classList.add('gato-solid');
            const duration = 12;
            const delay = -(now % duration);
            btn.style.setProperty('animation', `gatoRainbow ${duration}s linear infinite`, 'important');
            btn.style.setProperty('animation-delay', `${delay}s`, 'important');
            btn.style.setProperty('color', 'red', 'important');
            btn.style.removeProperty('filter');
        }

        let bUrl = null;
        if(userData.badge) bUrl = userData.badge;
        if(bUrl) injectBadge(btn, bUrl);
        else removeBadge(btn);
    }

    function applyGradient(btn, value) {
        btn.style.setProperty('background-image', value, 'important');
        btn.style.setProperty('background-clip', 'text', 'important');
        btn.style.setProperty('-webkit-background-clip', 'text', 'important');
        btn.style.setProperty('color', 'transparent', 'important');
        btn.style.setProperty('-webkit-text-fill-color', 'transparent', 'important');
    }

    function injectBadge(btn, url) {
        const parent = btn.parentNode;
        if(!parent) return;
        let img = parent.querySelector('img.gato-badge-icon[data-gato-badge="true"]');
        if(!img) {
            img = document.createElement('img');
            img.className = 'gato-badge-icon';
            img.dataset.gatoBadge = "true";
            parent.insertBefore(img, btn);
        }
        if(img.src !== url) img.src = url;
    }

    function removeBadge(btn) {
        const parent = btn.parentNode;
        if (!parent) return;
        const img = parent.querySelector('img.gato-badge-icon[data-gato-badge="true"]');
        if(img) img.remove();
    }

    // ===================== EMOTES LOGIC =====================
    function processContentNode(node) {
        node.setAttribute('data-gato-done', '1');
        if(!node.textContent) return;

        const row = node.closest('.group') || node.closest('.chat-entry');
        if(row) {
            const btn = row.querySelector('button[title]');
            if(btn) {
                const u = btn.getAttribute('title').trim().toLowerCase();
                if(PREMIUM[u] && PREMIUM[u].ink) {
                    node.style.setProperty('color', PREMIUM[u].ink.value || PREMIUM[u].ink, 'important');
                }
            }
        }

        const rawContent = node.textContent;
        const lowerContent = rawContent.toLowerCase();
        let hasPotential = false;
        for(let k of EMOTE_KEYS) {
            if(lowerContent.includes(k.toLowerCase())) { hasPotential = true; break; }
        }
        if(!hasPotential) return;

        const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT);
        const nodeList = [];
        while(walker.nextNode()) nodeList.push(walker.currentNode);

        nodeList.forEach(textNode => {
            const text = textNode.nodeValue;
            if(!text.trim()) return;
            
            let nodeHasKey = false;
             for(let k of EMOTE_KEYS) {
                 if(text.toLowerCase().includes(k.toLowerCase())) { nodeHasKey = true; break; }
             }
            if(!nodeHasKey) return;

            const fragment = document.createDocumentFragment();
            let changed = false;

            text.split(/(\s+)/).forEach(part => {
                const word = part.trim();
                if(!word) {
                    fragment.appendChild(document.createTextNode(part));
                    return;
                }

                let key = EMOTES[word] ? word : null;
                if(!key) key = Object.keys(EMOTES).find(k => k.toLowerCase() === word.toLowerCase());

                if (key) {
                    const em = EMOTES[key];
                    const isGlobal = !em.scope || em.scope === 'global';
                    
                    const channelList = (em.channel || "").toLowerCase().split(',');
                    const isChannel = em.scope === 'channel' && channelList.includes(CURRENT_CHANNEL);

                    if (isGlobal || isChannel) {
                        const img = document.createElement('img');
                        img.src = em.url;
                        img.className = 'gato-emote';
                        img.title = key;
                        img.onclick = () => insertToInput(key + " ");
                        fragment.appendChild(img);
                        changed = true;
                        return;
                    }
                }
                fragment.appendChild(document.createTextNode(part));
            });

            if (changed) {
                textNode.replaceWith(fragment);
            }
        });
    }

    function insertToInput(text) {
        const ed = document.querySelector('[contenteditable="true"]');
        if(ed) {
            ed.focus();
            if(!document.execCommand('insertText', false, text)) {
                const ev = new ClipboardEvent("paste", { bubbles:true, cancelable:true, clipboardData: new DataTransfer() });
                ev.clipboardData.setData('text/plain', text);
                ed.dispatchEvent(ev);
            }
        }
    }

    // ===================== AUTOCOMPLETE LOGIC =====================
    function injectAutocompleteGUI() {
        if(document.getElementById('gato-autocomplete')) return;
        const ac = document.createElement('div');
        ac.id = 'gato-autocomplete';
        document.body.appendChild(ac);
    }

    function closeAutocomplete() {
        const ac = document.getElementById('gato-autocomplete');
        if(ac) ac.style.display = 'none';
        acOpen = false;
        acMatches = [];
        acIndex = 0;
    }

    function updateAutocompleteGUI() {
        const ac = document.getElementById('gato-autocomplete');
        if(!ac) return;
        
        ac.innerHTML = '';
        acMatches.forEach((key, idx) => {
            const em = EMOTES[key];
            const div = document.createElement('div');
            div.className = `gato-ac-item ${idx === acIndex ? 'selected' : ''}`;
            div.innerHTML = `<img src="${em.url}"> ${key}`;
            div.onclick = () => {
                completeWord(key);
            };
            ac.appendChild(div);
        });

        const input = document.querySelector('[contenteditable="true"]');
        if(input) {
            const rect = input.getBoundingClientRect();
            ac.style.left = rect.left + "px";
            ac.style.bottom = (window.innerHeight - rect.top + 5) + "px"; 
            ac.style.display = 'flex';
        }
    }

    function completeWord(chosenKey) {
        const input = document.querySelector('[contenteditable="true"]');
        if(!input) return;
        
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const textNode = range.startContainer;
        
        if (textNode.nodeType === Node.TEXT_NODE) {
            const text = textNode.textContent;
            const cursor = range.startOffset;
            
            let start = text.lastIndexOf(' ', cursor - 1);
            if (start === -1) start = 0; else start += 1;
            
            const before = text.substring(0, start);
            const after = text.substring(cursor);
            
            textNode.textContent = before + chosenKey + " " + after;
            
            const newCursorPos = start + chosenKey.length + 1;
            const newRange = document.createRange();
            newRange.setStart(textNode, newCursorPos);
            newRange.setEnd(textNode, newCursorPos);
            sel.removeAllRanges();
            sel.addRange(newRange);
        }
        
        closeAutocomplete();
    }

    document.addEventListener('keydown', (e) => {
        const input = document.querySelector('[contenteditable="true"]');
        if (!input || document.activeElement !== input) return;

        if (e.key === 'Tab') {
            if (acOpen) {
                e.preventDefault();
                acIndex = (acIndex + 1) % acMatches.length;
                updateAutocompleteGUI();
            } else {
                const sel = window.getSelection();
                if (!sel.rangeCount) return;
                const range = sel.getRangeAt(0);
                const textNode = range.startContainer;

                if (textNode.nodeType === Node.TEXT_NODE) {
                    const text = textNode.textContent;
                    const cursor = range.startOffset;
                    
                    let start = text.lastIndexOf(' ', cursor - 1);
                    if (start === -1) start = 0; else start += 1;
                    const word = text.substring(start, cursor).trim();

                    if (word.length >= 2) {
                        const matches = EMOTE_KEYS.filter(k => {
                            const em = EMOTES[k];
                            const channelList = (em.channel || "").toLowerCase().split(',');
                            const isAllowed = (!em.scope || em.scope === 'global') || (em.scope === 'channel' && channelList.includes(CURRENT_CHANNEL));
                            return isAllowed && k.toLowerCase().startsWith(word.toLowerCase());
                        });

                        if (matches.length > 0) {
                            e.preventDefault();
                            acMatches = matches;
                            acIndex = 0;
                            acOpen = true;
                            updateAutocompleteGUI();
                        }
                    }
                }
            }
        } else if (e.key === 'Enter' && acOpen) {
            e.preventDefault();
            e.stopPropagation(); 
            completeWord(acMatches[acIndex]);
        } else if (e.key === 'Escape' && acOpen) {
            closeAutocomplete();
        } else if (acOpen && e.key.length === 1) {
            closeAutocomplete();
        }
    }, true); 

    // ===================== MENTIONS LOGIC (ZOPTYMALIZOWANE) =====================
    function scanMentions() {
        if (MY_USERNAME) {
            const btn = document.getElementById('gato-mentions-btn');
            if (btn && btn.dataset.waiting) {
                btn.textContent = 'CHAT';
                btn.style.background = '#000';
                btn.style.color = '#00ff00';
                delete btn.dataset.waiting;
                btn.onclick = toggleMentionsUI;
            }
        }

        if (!MY_USERNAME) {
            MY_USERNAME = localStorage.getItem('gato_kick_username');
            if (!MY_USERNAME) {
                try {
                    const html = document.body.innerHTML;
                    const match = html.match(/"user":\{[^}]*"username":"([^"]+)"/);
                    if (match && match[1]) MY_USERNAME = match[1];
                } catch(e) {}
            }
            if (!MY_USERNAME) {
                const navImgs = document.querySelectorAll('nav img[alt], #user-menu-button img[alt]');
                for (let img of navImgs) {
                    if (img.alt && img.alt.length > 1) {
                        MY_USERNAME = img.alt.trim();
                        break;
                    }
                }
            }

            const btn = document.getElementById('gato-mentions-btn');
            if (!MY_USERNAME) {
                if (btn && !btn.dataset.waiting) {
                    btn.textContent = 'CHAT (Ustaw Nick)';
                    btn.style.background = '#333';
                    btn.style.color = '#888';
                    btn.dataset.waiting = 'true';
                    btn.onclick = () => {
                        const manual = prompt("Wpisz swÃ³j nick z Kicka:");
                        if(manual) {
                            MY_USERNAME = manual.trim();
                            localStorage.setItem('gato_kick_username', MY_USERNAME);
                            btn.textContent = 'CHAT';
                            btn.style.background = '#000';
                            btn.style.color = '#00ff00';
                            delete btn.dataset.waiting;
                            btn.onclick = toggleMentionsUI;
                            scanMentions();
                        }
                    };
                }
                return;
            } else {
                localStorage.setItem('gato_kick_username', MY_USERNAME);
            }
        }

        const chatRoot = document.getElementById('chat-chatroom') || document.body;
        const allRows = Array.from(chatRoot.querySelectorAll('.group'));
        // ZwiÄ™kszamy zakres i usuwamy filtr 'checked', aby zawsze liczyÄ‡ wszystkie widoczne duplikaty
        const candidates = allRows.slice(-75);

        let foundNew = false;
        const now = Date.now();
        const currentDate = new Date();
        const currentHM = currentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const currentMinutes = currentDate.getHours() * 60 + currentDate.getMinutes();

        // 1. Czyszczenie starego cache (3 minuty)
        for (const [sig, data] of PROCESSED_MESSAGES.entries()) {
            if (now - data.lastSeen > 180000) PROCESSED_MESSAGES.delete(sig);
        }

        // 2. Agregacja: Zliczamy ile razy dana wiadomoÅ›Ä‡ wystÄ™puje TERAZ na ekranie
        const currentScan = new Map(); // Sig -> { count, author, text, msgTime }

        candidates.forEach(row => {
            const authorEl = row.querySelector('.font-bold');
            const author = authorEl ? authorEl.textContent.trim() : "Nieznany";
            
            // Lepsze wyciÄ…ganie tekstu (omijanie odznak i czasu)
            const contentEl = row.querySelector('.break-words') || row.querySelector('.chat-entry-content');
            let text = "";
            if (contentEl) {
                text = Array.from(contentEl.childNodes).map(n => {
                    if (n.nodeType === Node.TEXT_NODE) return n.textContent;
                    if (n.nodeName === 'IMG') return n.alt || n.title || '';
                    return n.textContent || '';
                }).join('').trim();
            } else {
                text = row.innerText.replace(author, '').trim();
            }

            let msgTime = currentHM;
            let msgMinutes = currentMinutes;
            
            // Szukamy elementu z czasem
            const timeEl = row.querySelector('time') || row.querySelector('.text-xs');
            let timeText = timeEl ? timeEl.textContent.trim() : text;
            
            const timeMatch = timeText.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                msgTime = timeMatch[0];
                const h = parseInt(timeMatch[1]);
                const m = parseInt(timeMatch[2]);
                msgMinutes = h * 60 + m;
                if (!timeEl) text = text.replace(msgTime, '').trim();
            }
            
            if (text.startsWith(':')) text = text.substring(1).trim();

            let diff = currentMinutes - msgMinutes;
            if (diff < 0) diff += 24 * 60; 
            
            if (diff > 3) return; 

            const signature = `${author}|${text}|${msgTime}`;
            
            if (!currentScan.has(signature)) {
                currentScan.set(signature, { count: 0, author, text, msgTime });
            }
            currentScan.get(signature).count++;
        });

        // 3. Przetwarzanie rÃ³Å¼nic (PorÃ³wnanie widocznych vs przetworzonych)
        const escapedUsername = MY_USERNAME.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const mentionRegex = new RegExp('@' + escapedUsername + '\\b', 'i');
        const replyRegex = new RegExp('^OdpowiedÅº do\\s+' + escapedUsername + '.*:', 'i');
        const selfReplyRegex = new RegExp('^OdpowiedÅº do\\s+([^:]+):', 'i');

        currentScan.forEach((data, sig) => {
            const stored = PROCESSED_MESSAGES.get(sig) || { count: 0, lastSeen: 0 };
            
            // JeÅ›li widzimy wiÄ™cej wiadomoÅ›ci niÅ¼ mamy w pamiÄ™ci -> to sÄ… nowe duplikaty/wiadomoÅ›ci
            if (data.count > stored.count) {
                const newMessagesCount = data.count - stored.count;
                
                for (let i = 0; i < newMessagesCount; i++) {
                    // Sprawdzanie wzmianki
                    if (mentionRegex.test(data.text) || replyRegex.test(data.text)) {
                        if (!MENTIONS_LOG[data.author]) MENTIONS_LOG[data.author] = [];
                        MENTIONS_LOG[data.author].push({
                            text: data.text,
                            time: data.msgTime,
                            timestamp: now,
                            isSelf: false,
                            author: data.author
                        });
                        foundNew = true;
                        NEW_MENTIONS_COUNT++;
                    }
                    // Sprawdzanie wÅ‚asnej odpowiedzi
                    else if (data.author.toLowerCase() === MY_USERNAME.toLowerCase()) {
                        const atMatch = data.text.match(/^@([^\s]+)/);
                        const replyMatch = data.text.match(selfReplyRegex);

                        let targetUser = null;
                        if (atMatch) targetUser = atMatch[1].replace(/[,.:;!?]$/, '');
                        else if (replyMatch) targetUser = replyMatch[1].trim();

                        if (targetUser) {
                            const targetKey = Object.keys(MENTIONS_LOG).find(k => k.toLowerCase() === targetUser.toLowerCase());
                            if (targetKey) {
                                MENTIONS_LOG[targetKey].push({
                                    text: data.text,
                                    time: data.msgTime,
                                    timestamp: now,
                                    isSelf: true,
                                    author: MY_USERNAME
                                });
                                const ui = document.getElementById('gato-mentions-ui');
                                if (ui && ui.style.display === 'flex') renderMentionsList();
                            }
                        }
                    }
                }
                stored.count = data.count;
            }
            
            stored.lastSeen = now;
            PROCESSED_MESSAGES.set(sig, stored);
        });

        if (foundNew) {
            const btn = document.getElementById('gato-mentions-btn');
            if(btn) {
                btn.style.background = '#ef4444';
                btn.style.color = 'white';
                btn.textContent = `CHAT (${NEW_MENTIONS_COUNT})`;
            }
            const ui = document.getElementById('gato-mentions-ui');
            if (ui && ui.style.display === 'flex') renderMentionsList();

            if (!isTitleBlinking) {
                startTitleBlinking();
            }
        }
    }

    function renderMentionsList() {
        const authorsDiv = document.querySelector('#gatoMentionsList .gato-m-authors');
        const messagesDiv = document.querySelector('#gatoMentionsList .gato-m-messages');

        if (!authorsDiv || !messagesDiv) return;

        authorsDiv.innerHTML = '';
        messagesDiv.innerHTML = '';

        const allAuthorsDiv = document.createElement('div');
        allAuthorsDiv.className = 'gato-m-author';
        allAuthorsDiv.textContent = 'Wszyscy';
        allAuthorsDiv.onclick = () => renderMessages('all');
        authorsDiv.appendChild(allAuthorsDiv);

        Object.keys(MENTIONS_LOG).forEach(author => {
            const authorDiv = document.createElement('div');
            authorDiv.className = 'gato-m-author';
            authorDiv.textContent = author;
            authorDiv.onclick = () => renderMessages(author);
            authorsDiv.appendChild(authorDiv);
        });

        function renderMessages(author) {
            document.querySelectorAll('#gatoMentionsList .gato-m-author.active').forEach(el => el.classList.remove('active'));
            const clickedEl = Array.from(document.querySelectorAll('#gatoMentionsList .gato-m-author')).find(el => el.textContent === author);
            if (clickedEl) clickedEl.classList.add('active');

            messagesDiv.innerHTML = '';
            let messages = [];
            
            if (author !== 'all') {
                const header = document.createElement('div');
                header.style.cssText = "padding:10px; border-bottom:1px solid #333; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;";
                header.innerHTML = `<span style="color:#888; font-size:11px;">Rozmowa z ${author}</span>`;
                
                const replyBtn = document.createElement('button');
                replyBtn.textContent = "Odpowiedz";
                replyBtn.style.cssText = "background:#00ff00; color:black; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:11px;";
                replyBtn.onclick = () => {
                    document.getElementById('gato-mentions-ui').style.display = 'none';
                    insertToInput("@" + author + " ");
                };
                
                header.appendChild(replyBtn);
                messagesDiv.appendChild(header);
            }

            if (author === 'all') {
                Object.values(MENTIONS_LOG).forEach(msgs => messages = messages.concat(msgs));
            } else {
                messages = MENTIONS_LOG[author] || [];
            }

            if (messages.length === 0) {
                messagesDiv.innerHTML = `<div class="gato-m-empty">Brak wzmianek.</div>`;
                return;
            }

            const displayMessages = [...messages].reverse();

            displayMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'gato-m-msg';
                if (msg.isSelf) {
                    msgDiv.style.borderLeft = '3px solid #0088ff';
                    msgDiv.style.background = '#0f172a';
                }
                
                const header = document.createElement('div');
                header.style.cssText = "display:flex; justify-content:space-between; margin-bottom:4px; font-size:10px; color:#666; font-weight:bold; text-transform:uppercase;";
                
                const displayAuthor = msg.author || (msg.isSelf ? MY_USERNAME : author);
                const nickSpan = document.createElement('span');
                nickSpan.textContent = displayAuthor;
                nickSpan.style.color = msg.isSelf ? '#0088ff' : '#00ff00';
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = msg.time;
                
                header.appendChild(nickSpan);
                header.appendChild(timeSpan);
                
                const body = document.createElement('div');
                body.textContent = msg.text;
                body.style.color = msg.isSelf ? '#93c5fd' : '#e4e4e7';
                
                msgDiv.appendChild(header);
                msgDiv.appendChild(body);
                
                messagesDiv.appendChild(msgDiv);
            });
        }
        
        renderMessages('all');
        const h = document.querySelector('#gato-mentions-ui .gato-m-header span');
        if(h) h.textContent = `Wzmianki (@${MY_USERNAME || '?'})`;
    }

    function startTitleBlinking() {
        if (isTitleBlinking) return;
        isTitleBlinking = true;
        if (!document.title.startsWith("ðŸ”” Powiadomienie")) {
            titleBeforeBlinking = document.title;
        }
        blinkState = false;

        if (blinkInterval) clearInterval(blinkInterval);

        blinkInterval = setInterval(() => {
            if (NEW_MENTIONS_COUNT === 0) {
                stopTitleBlinking();
                return;
            }

            // UsuniÄ™to warunek document.hidden - teraz miga zawsze, dopÃ³ki nie klikniesz CHAT
            blinkState = !blinkState;
            const newTitle = blinkState ? `ðŸ”” Powiadomienie (${NEW_MENTIONS_COUNT})` : titleBeforeBlinking;
            try { document.title = newTitle; } catch(e) {}
        }, 1000);
    }

    function stopTitleBlinking() {
        if (!isTitleBlinking) return;
        clearInterval(blinkInterval);
        blinkInterval = null;
        isTitleBlinking = false;
        if (document.title.startsWith("ðŸ”” Powiadomienie")) {
            if (titleBeforeBlinking && !titleBeforeBlinking.startsWith("ðŸ”” Powiadomienie")) {
                document.title = titleBeforeBlinking;
            } else {
                document.title = CURRENT_CHANNEL ? (CURRENT_CHANNEL.charAt(0).toUpperCase() + CURRENT_CHANNEL.slice(1) + " | Kick") : "Kick";
            }
        }
    }

    function injectInterface() {
        if (document.getElementById('gato-mentions-btn')) return;
        const input = document.querySelector('[contenteditable="true"]');
        if (!input) return;
        
        let container = input.closest('form');
        if (!container) {
            const rel = input.closest('.relative');
            if (rel) container = rel.parentElement;
        }
        if (!container || !container.parentNode) return;

        const btnContainer = document.createElement('div');
        btnContainer.id = 'gato-buttons-container';

        const chatBtn = document.createElement('div');
        chatBtn.id = 'gato-mentions-btn';
        chatBtn.className = 'gato-panel-btn';
        chatBtn.textContent = 'CHAT';
        chatBtn.onclick = toggleMentionsUI;

        const menuBtn = document.createElement('div');
        menuBtn.id = 'gato-menu-btn';
        menuBtn.className = 'gato-panel-btn';
        menuBtn.textContent = 'EMOTES';
        menuBtn.onclick = toggleEmoteMenu;

        const settingsBtn = document.createElement('div');
        settingsBtn.id = 'gato-settings-btn';
        settingsBtn.className = 'gato-panel-btn';
        settingsBtn.textContent = 'SETTINGS';
        settingsBtn.onclick = toggleSettingsMenu;

        btnContainer.appendChild(chatBtn);
        btnContainer.appendChild(menuBtn);
        btnContainer.appendChild(settingsBtn);
        
        if (container.parentNode) {
            container.parentNode.insertBefore(btnContainer, container.nextSibling);
        }
        
        if (!document.getElementById('gato-mentions-ui')) {
            const ui = document.createElement('div');
            ui.id = 'gato-mentions-ui';
            ui.innerHTML = `
                <div class="gato-m-header">
                    <span>Wzmianki (@${MY_USERNAME || '...'})</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="cursor:pointer; font-size:16px;" id="gatoMentionClear" title="WyczyÅ›Ä‡ historiÄ™">ðŸ—‘ï¸</span>
                        <span style="cursor:pointer; font-size:16px;" id="gatoMentionClose">âœ–</span>
                    </div>
                </div>
                <div class="gato-m-content" id="gatoMentionsList"></div>
           `;
            document.body.appendChild(ui);
            
            document.getElementById('gatoMentionClose').onclick = () => document.getElementById('gato-mentions-ui').style.display='none';
            document.getElementById('gatoMentionClear').onclick = () => {
                if(confirm("Czy na pewno chcesz wyczyÅ›ciÄ‡ historiÄ™ wzmianek?")) {
                    MENTIONS_LOG = {};
                    NEW_MENTIONS_COUNT = 0;
                    renderMentionsList();
                    stopTitleBlinking();
                    const btn = document.getElementById('gato-mentions-btn');
                    if(btn) {
                        btn.style.background = '#000';
                        btn.style.color = '#00ff00';
                        btn.textContent = 'CHAT';
                    }
                }
            };
        }

        const contentDiv = document.getElementById('gatoMentionsList');
        contentDiv.innerHTML = '<div class="gato-m-authors"></div><div class="gato-m-messages"></div>';

    }

    function toggleMentionsUI() {
        const ui = document.getElementById('gato-mentions-ui');
        if (!ui) return;
        if (ui.style.display === 'flex') {
            ui.style.display = 'none';
        } else {
            const menu = document.getElementById('gato-menu');
            if(menu) { menu.style.display = 'none'; menuOpen = false; }
            const settings = document.getElementById('gato-settings-menu');
            if(settings) settings.style.display = 'none';

            stopTitleBlinking(); 

            const btn = document.getElementById('gato-mentions-btn');
            if(btn) {
                btn.style.background = '#000';
                btn.style.color = '#00ff00';
                btn.textContent = 'CHAT';
            }
            NEW_MENTIONS_COUNT = 0; 
            renderMentionsList();
            ui.style.display = 'flex';
        }
    }

    function toggleGreen() {
        FORCE_GREEN = !FORCE_GREEN;
        localStorage.setItem('gato_force_green', FORCE_GREEN);
        document.body.classList.toggle('gato-green-enabled', FORCE_GREEN);
        
        const switchEl = document.querySelector('#gato-green-toggle .gato-toggle-switch');
        if(switchEl) {
            if(FORCE_GREEN) switchEl.classList.add('active');
            else switchEl.classList.remove('active');
        }
        
        if (!FORCE_GREEN) {
             const buttons = document.querySelectorAll('button[data-gato-paint-id="green"]');
             buttons.forEach(b => resetToDefault(b));
        }
    }

    function togglePinned() {
        HIDE_PINNED = !HIDE_PINNED;
        localStorage.setItem('gato_hide_pinned', HIDE_PINNED);
        
        const switchEl = document.querySelector('#gato-pinned-toggle .gato-toggle-switch');
        if(switchEl) {
            if(HIDE_PINNED) switchEl.classList.add('active');
            else switchEl.classList.remove('active');
        }
    }

    function toggleEnlarge() {
        ENLARGE_CHAT = !ENLARGE_CHAT;
        localStorage.setItem('gato_enlarge_chat', ENLARGE_CHAT);
        document.body.classList.toggle('gato-enlarge-enabled', ENLARGE_CHAT);
        
        const switchEl = document.querySelector('#gato-enlarge-toggle .gato-toggle-switch');
        if(switchEl) {
            if(ENLARGE_CHAT) switchEl.classList.add('active');
            else switchEl.classList.remove('active');
        }
    }

    // ===================== GUI LOGIC =====================
    if(!document.getElementById('gato-menu')) {
        const menu = document.createElement('div');
        menu.id = 'gato-menu';
        menu.innerHTML = `
            <div class="gato-menu-header"><span>Emotki</span><span style="cursor:pointer" id="gatoCloseMenu">âœ–</span></div>
            <div class="gato-menu-tabs"><div id="tabChannel" class="gato-tab active">KANAÅ</div><div id="tabGlobal" class="gato-tab">GLOBALNE</div><div id="tab7TV" class="gato-tab">7TV</div></div>
            <div class="gato-menu-search-container"><input type="text" id="gatoSearchInput" placeholder="Szukaj emotki..." autocomplete="off"></div>
            <div class="gato-menu-content" id="gatoMenuContent"></div>
            <div class="gato-menu-footer">
                <a href="${COSMETICS_URL}" target="_blank" class="gato-cosmetics-btn">âœ¨ Cosmetics</a>
            </div>
        `;
        document.body.appendChild(menu);

        setTimeout(() => {
            document.getElementById('gatoCloseMenu').onclick = (e) => { e.stopPropagation(); document.getElementById('gato-menu').style.display = 'none'; menuOpen = false; };
            document.getElementById('tabChannel').onclick = (e) => { e.stopPropagation(); switchEmoteTab('channel'); };
            document.getElementById('tabGlobal').onclick = (e) => { e.stopPropagation(); switchEmoteTab('global'); };
            document.getElementById('tab7TV').onclick = (e) => { e.stopPropagation(); switchEmoteTab('7tv'); };
            document.getElementById('gatoSearchInput').addEventListener('input', (e) => { renderEmoteMenu(e.target.value); });
        }, 500);
    }

    // ===================== SETTINGS MENU =====================
    if(!document.getElementById('gato-settings-menu')) {
        const settings = document.createElement('div');
        settings.id = 'gato-settings-menu';
        settings.innerHTML = `
            <div class="gato-settings-header"><span>Ustawienia Gato</span><span style="cursor:pointer" id="gatoCloseSettings">âœ–</span></div>
            <div class="gato-settings-content">
                <div id="gato-green-toggle" class="gato-toggle-row">
                    <div class="gato-toggle-label">ðŸŸ¢ Zielone Nicki</div>
                    <div class="gato-toggle-switch ${FORCE_GREEN?'active':''}">
                        <div class="gato-toggle-knob"></div>
                    </div>
                </div>
                <div id="gato-pinned-toggle" class="gato-toggle-row">
                    <div class="gato-toggle-label">ðŸ“Œ Ukryj PrzypiÄ™te</div>
                    <div class="gato-toggle-switch ${HIDE_PINNED?'active':''}">
                        <div class="gato-toggle-knob"></div>
                    </div>
                </div>
                <div id="gato-enlarge-toggle" class="gato-toggle-row">
                    <div class="gato-toggle-label">ðŸ“ PowiÄ™ksz Chat</div>
                    <div class="gato-toggle-switch ${ENLARGE_CHAT?'active':''}">
                        <div class="gato-toggle-knob"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(settings);

        setTimeout(() => {
            document.getElementById('gatoCloseSettings').onclick = (e) => { e.stopPropagation(); document.getElementById('gato-settings-menu').style.display = 'none'; };
            document.getElementById('gato-green-toggle').onclick = (e) => { e.stopPropagation(); toggleGreen(); };
            document.getElementById('gato-pinned-toggle').onclick = (e) => { e.stopPropagation(); togglePinned(); };
            document.getElementById('gato-enlarge-toggle').onclick = (e) => { e.stopPropagation(); toggleEnlarge(); };
        }, 500);
    }

    function toggleEmoteMenu() {
        const menu = document.getElementById('gato-menu');
        if (!menu) return;
        if (menu.style.display === 'flex') { menu.style.display = 'none'; menuOpen = false; }
        else { 
            const ui = document.getElementById('gato-mentions-ui');
            if(ui) ui.style.display = 'none';
            const settings = document.getElementById('gato-settings-menu');
            if(settings) settings.style.display = 'none';

            menu.style.display = 'flex'; menuOpen = true; switchEmoteTab('channel'); 
        }
    }

    function toggleSettingsMenu() {
        const menu = document.getElementById('gato-settings-menu');
        if (!menu) return;
        if (menu.style.display === 'flex') menu.style.display = 'none';
        else {
            const ui = document.getElementById('gato-mentions-ui');
            if(ui) ui.style.display = 'none';
            const emoteMenu = document.getElementById('gato-menu');
            if(emoteMenu) { emoteMenu.style.display = 'none'; menuOpen = false; }

            menu.style.display = 'flex';
        }
    }

    function switchEmoteTab(tab) {
        EMOTE_TAB = tab;
        document.getElementById('tabChannel').className = (tab === 'channel') ? 'gato-tab active' : 'gato-tab';
        document.getElementById('tabGlobal').className = (tab === 'global') ? 'gato-tab active' : 'gato-tab';
        document.getElementById('tab7TV').className = (tab === '7tv') ? 'gato-tab active' : 'gato-tab';
        renderEmoteMenu(document.getElementById('gatoSearchInput').value);
    }

    function renderEmoteMenu(filterText = "") {
        const content = document.getElementById('gatoMenuContent');
        if (!content) return;
        content.innerHTML = '';
        const filterLower = filterText.toLowerCase();

        if (EMOTE_TAB === '7tv') {
            const box = document.createElement('div');
            box.style.cssText = "grid-column: 1 / -1; background: #18181b; border: 1px solid #333; padding: 8px; border-radius: 6px; margin-bottom: 8px;";
            
            if (CURRENT_SEVENTV_ID && Object.keys(SEVENTV_EMOTES).length > 0) {
                // LOADED STATE
                box.innerHTML = `
                    <div style="display:flex; justify-content:center; align-items:center; background:rgba(34, 197, 94, 0.1); border:1px solid #22c55e; padding:8px; border-radius:4px;">
                        <div style="color:#22c55e; font-weight:800; font-size:11px; display:flex; align-items:center; gap:5px;">
                            <img src="https://7tv.app/favicon.ico" style="width:12px; height:12px;"> ZESTAW KANAÅU ZAÅADOWANY
                        </div>
                    </div>
                    <div style="font-size:10px; color:#666; margin-top:5px; text-align:center;">ID: ${CURRENT_SEVENTV_ID} (${Object.keys(SEVENTV_EMOTES).length} emotek)</div>
                `;
            } else {
                // EMPTY STATE
                box.innerHTML = `
                    <div style="text-align:center; color:#666; font-size:11px; padding:10px;">
                        Ten kanaÅ‚ nie ma przypisanego zestawu 7TV w Gato.TV.
                    </div>
                `;
            }

            content.appendChild(box);

            const keys = Object.keys(SEVENTV_EMOTES).filter(k => filterText === "" || k.toLowerCase().includes(filterLower));
            keys.forEach(name => {
                const data = SEVENTV_EMOTES[name];
                const item = document.createElement('div');
                item.className = 'gato-menu-item';
                item.title = name;
                item.innerHTML = `<img src="${data.url}">`;
                item.onclick = (e) => { e.stopPropagation(); insertToInput(name + " "); };
                content.appendChild(item);
            });
            return;
        }

        const filteredKeys = EMOTE_KEYS.filter(k => {
            const data = EMOTES[k];
            
            let matchesTab = false;
            if (EMOTE_TAB === 'channel') {
                const channelList = (data.channel || "").toLowerCase().split(',');
                matchesTab = data.scope === 'channel' && channelList.includes(CURRENT_CHANNEL);
            } else {
                matchesTab = !data.scope || data.scope === 'global';
            }

            return matchesTab && (filterText === "" || k.toLowerCase().includes(filterLower));
        });

        if (filteredKeys.length === 0) {
            content.innerHTML = `<div class="gato-menu-empty">${EMOTE_TAB === 'channel' ? "Brak emotek na tym kanale." : "Brak emotek globalnych."}</div>`;
            return;
        }

        filteredKeys.forEach(name => {
            const data = EMOTES[name];
            const item = document.createElement('div');
            item.className = 'gato-menu-item';
            item.title = name;
            item.innerHTML = `<img src="${data.url}">`;
            item.onclick = (e) => { e.stopPropagation(); insertToInput(name + " "); };
            content.appendChild(item);
        });
    }

    // ===================== RUN =====================
    fetchData();
    setInterval(fetchData, REFRESH_RATE);
    setInterval(renderLoop, RENDER_RATE);
    
    const obs = new MutationObserver(renderLoop);
    obs.observe(document.body, { childList: true, subtree: true });

    document.addEventListener('click', (e) => {
        const menu = document.getElementById('gato-menu');
        const settings = document.getElementById('gato-settings-menu');
        const btn = document.getElementById('gato-menu-btn');
        const btnSettings = document.getElementById('gato-settings-btn');
        
        if (menu && menu.style.display === 'flex' && !menu.contains(e.target) && (!btn || !btn.contains(e.target)) && e.target.id !== 'gato-menu-btn') {
            menu.style.display = 'none';
            menuOpen = false;
        }
        if (settings && settings.style.display === 'flex' && !settings.contains(e.target) && (!btnSettings || !btnSettings.contains(e.target)) && e.target.id !== 'gato-settings-btn') {
            settings.style.display = 'none';
        }
    });

})();
